<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج مؤشر أداء المشغل</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- خط Noto Sans Arabic لـلغة العربية -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- مكتبة jsPDF لتصدير PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* التنسيق العام للخطوط والألوان */
        :root {
            --header-bg: #EAC696; /* بني ذهبي فاتح رملي */
            --button-bg: #C89F6F; /* بني رملي ذهبي أغمق */
        }

        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            background-color: #f8f8f8;
            padding-bottom: 60px; /* مساحة للفوتر */
        }

        /* تنسيق الأزرار المشترك */
        .app-btn {
            background-color: var(--button-bg);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            white-space: nowrap; /* منع انقسام نص الزر */
        }

        .app-btn:hover {
            background-color: #A0835B;
        }

        /* تنسيق رأس البرنامج - ارتفاع 120px */
        .app-header {
            height: 120px;
            background-color: var(--header-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* تنسيق الفوتر - ارتفاع 60px */
        .app-footer {
            height: 60px;
            background-color: var(--header-bg);
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* تحديد الألوان الخاصة بأعمدة التقييم */
        .bg-supervisor { background-color: #E6FFEC; } /* أخضر فاتح */
        .bg-accountant { background-color: #FFFBE6; } /* بني فاتح (أصفر باهت) */
        .bg-butcher { background-color: #FFE6E6; }    /* أحمر فاتح */
        .bg-cleaner { background-color: #FFF3E6; }    /* برتقالي فاتح */

        /* تخصيص لطباعة الفاتورة */
        @media print {
            body {
                margin: 0;
                /* تحديد اتجاه الطباعة للمناظر الطبيعية (Landscape) */
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                /* تحديد حجم A4 مع اتجاه أفقي */
                size: A4 landscape;
            }
            #app-container { display: none; }
            #invoice-print-view {
                display: block !important;
                width: 100vw;
                height: 100vh;
                margin: 0 auto;
                padding: 10mm;
            }
            /* جعل الفاتورة تملأ العرض عند الطباعة */
            #invoice-printable {
                min-width: 100%;
                box-shadow: none !important;
            }
        }
        
        /* إشعارات */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #EF4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* تحسينات للجداول */
        .staff-table th, .staff-table td {
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        
        /* تنسيق خاص للتقارير الشهرية */
        .monthly-report-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .monthly-report-table th, 
        .monthly-report-table td {
            border: 1px solid #000;
            padding: 8px;
            text-align: center;
        }
        
        .monthly-report-table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        /* تنسيق التوقيعات */
        .signature-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9f9f9;
            margin-top: 10px;
        }
        
        .signature-preview {
            max-width: 200px;
            max-height: 80px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* تنسيق جداول التقييم الشهري */
        .monthly-evaluation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        
        .monthly-evaluation-table th, 
        .monthly-evaluation-table td {
            border: 1px solid #ccc;
            padding: 4px;
            text-align: center;
        }
        
        .monthly-evaluation-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .monthly-evaluation-table .kpi-name {
            text-align: right;
            font-weight: bold;
            background-color: #f9f9f9;
        }
        
        .monthly-evaluation-table .staff-name {
            white-space: nowrap;
            background-color: #f0f0f0;
        }

        /* رسائل النجاح العابرة (Toast) */
        .success-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: fadeInOut 3s ease-in-out;
            font-weight: bold;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; top: 0; }
            10% { opacity: 1; top: 20px; }
            90% { opacity: 1; top: 20px; }
            100% { opacity: 0; top: 0; }
        }
    </style>
</head>

<body class="bg-white">

    <!-- شاشة الترحيب واللوحات الأخرى -->
    <div id="app-container" class="min-h-screen flex flex-col items-center">

        <!-- رأس البرنامج المشترك -->
        <header id="app-header" class="app-header w-full flex flex-col md:flex-row items-center justify-between p-4 shadow-lg hidden">
            <h1 id="header-title" class="text-3xl font-bold text-amber-900 mb-2 md:mb-0"></h1>
            <!-- تم إضافة flex-wrap و gap-2 لضمان عدم تداخل الأزرار على الشاشات الصغيرة -->
            <nav id="navbar" class="flex flex-wrap justify-center md:justify-end gap-2"></nav>
        </header>

        <!-- المحتوى الرئيسي للشاشة -->
        <main id="main-content" class="w-full max-w-7xl flex-grow p-4 md:p-8"></main>
    </div>

    <!-- الفوتر -->
    <footer class="app-footer">
        <p class="text-amber-900 font-medium">جميع الحقوق محفوظة - النظام تجريبي وليس رسمي</p>
    </footer>

    <!-- حاوية عرض الطباعة (مخفية حتى يتم الضغط على زر الطباعة) -->
    <div id="invoice-print-view" class="hidden"></div>
    
    <!-- Modal Container -->
    <div id="appModal" class="hidden"></div>

    <script>
        // === 1. تعريف المتغيرات والقيم الأولية ===
        const LS_KEY = 'abattoir_kpi_data_v13'; // زيادة رقم الإصدار
        const APP_STATE = {
            currentScreen: 'splash',
            isAuthReady: false,
            loggedInUser: null,
            isAdmin: false,
            isApprover: false,
            isCoordinator: false,
            currentSite: null,
            currentReportDate: new Date().toISOString().split('T')[0],
        };

        // الهيكل الافتراضي للبيانات
        let DATA = {
            settings: {
                users: [
                    { id: '70062', name: 'Musab Ali (Admin)', role: 'admin', siteId: 'Ghayathi', signature: null },
                    { id: '70060', name: 'Fadil (User)', role: 'user', siteId: 'Sil', signature: null },
                    { id: '00000', name: 'مدير الادارة (Approver)', role: 'approver', siteId: 'All', signature: null },
                    { id: '00001', name: 'رئيس الشعبة (Coordinator)', role: 'coordinator', siteId: 'All', signature: null }
                ],
                sites: [
                    { 
                        id: 'Ghayathi', 
                        name: 'مسلخ غياثي', 
                        operator: 'شركة الجزيرة الخضراء للاغنام والمواشي', 
                        contract: 'DRM-0024/2', 
                        staff: [
                            { role: 'مشرف', name: 'عبد العزيز وفيق ', id: 'M001' },
                            { role: 'محاسب', name: 'صافي الدين الضو', id: 'A001' },
                            { role: 'مراقب', name: 'محمد شهباز', id: 'S001' },
                            { role: 'قصاب', name: 'محمد وفيق', id: 'B001' },
                            { role: 'قصاب', name: 'احمد محمود', id: 'B002' },
                            { role: 'قصاب', name: 'عمر عبدالسلام', id: 'B003' },
                            { role: 'قصاب', name: 'صبري برعي', id: 'B004' },
                            { role: 'عامل نظافة', name: 'سفير احمد', id: 'C001' },
                            { role: 'عامل نظافة', name: 'اياز خان', id: 'C002' },
                            { role: 'حمال', name: 'ايمن الفخراني', id: 'L001' }
                        ] 
                    },
                    { 
                        id: 'Sil', 
                        name: 'مسلخ مدينة السلع', 
                        operator: 'شركة الجزيرة الخضراء للاغنام والمواشي', 
                        contract: 'SLM-001/24', 
                        staff: [
                            { role: 'مشرف', name: 'اسامة محمد', id: 'M002' },
                            { role: 'محاسب', name: 'هاني جعفر', id: 'A002' },
                            { role: 'مراقب', name: 'راشد ناصر', id: 'S002' },
                            { role: 'قصاب', name: 'جاسم محمد', id: 'B005' },
                            { role: 'قصاب', name: 'عبدالله علي', id: 'B006' },
                            { role: 'قصاب', name: 'سالم أحمد', id: 'B007' },
                            { role: 'قصاب', name: 'محمد خالد', id: 'B008' },
                            { role: 'عامل نظافة', name: 'خليفة محمد', id: 'C003' },
                            { role: 'عامل نظافة', name: 'ناصر عبدالله', id: 'C004' },
                            { role: 'حمال', name: 'أحمد محمود', id: 'L002' }
                        ] 
                    }
                ],
                // تحديث قائمة KPI لربطها بالهيكلة الجديدة للتقرير الشهري
                kpis: [
                    // A. خدمات الإدارة
                    { name: 'الحضور والانصراف', category: 'الإدارة', workers: ['مشرف', 'محاسب', 'مراقب', 'قصاب', 'عامل نظافة', 'حمال'] },
                    { name: 'توفير تقارير إدارية من المشرف', category: 'الإدارة', workers: ['مشرف'] },
                    
                    // B. خدمات الذبح
                    { name: 'النظافة الشخصية', category: 'الذبح', workers: ['قصاب', 'عامل نظافة', 'حمال'] },
                    { name: 'نظافة المعدات', category: 'الذبح', workers: ['قصاب', 'عامل نظافة', 'حمال'] },
                    { name: 'نظافة مكان العمل', category: 'الذبح', workers: ['قصاب', 'عامل نظافة', 'حمال'] },
                    { name: 'توفير المعدات والأدوات للعمل', category: 'الذبح', workers: ['مشرف'] },
                    
                    // C. خدمات النظافة والصحة
                    { name: 'شهادات تدريب السلامة الغذائية EFST', category: 'النظافة والصحة', workers: ['مشرف', 'محاسب', 'مراقب', 'قصاب', 'عامل نظافة', 'حمال'] },
                    { name: 'شهادة تدريب السلامة المهنية', category: 'النظافة والصحة', workers: ['مشرف', 'محاسب', 'مراقب', 'قصاب', 'عامل نظافة', 'حمال'] },
                    { name: 'توفير مستلزمات النظافة والمنظفات', category: 'النظافة والصحة', workers: ['مشرف'] },
                    
                    // D. خدمات الصيانة
                    { name: 'الصيانة المطلوبة من المقاول', category: 'الصيانة', workers: ['مشرف'] }
                ],
                // تكاليف وأعداد افتراضية
                invoiceCosts: {
                    'مشرف': 4500, 'محاسب': 3500, 'مراقب': 2250, 'قصاب': 11500, 'عامل نظافة': 2300, 'حمال': 2000, 'مواد التنظيف': 1000
                },
                violations: [
                    { id: 1, name: 'غياب مشرف العمال', value: 500, description: 'خصم لغياب مشرف العمال.', category: 'الإدارة', unit: 'يوم' },
                    { id: 2, name: 'غياب (محاسب - قصاب - عامل نظافة - عامل جلود - حمال)', value: 300, description: 'خصم لغياب العمال.', category: 'الإدارة', unit: 'عامل يوم' },
                    { id: 3, name: 'مخالفة شروط الصحة والسلامة المهنية', value: 400, description: 'خصم لمخالفة شروط الصحة والسلامة المهنية.', category: 'النظافة والصحة', unit: 'يوم' },
                    { id: 4, name: 'مخالفة النظافة والتطهير', value: 350, description: 'خصم لمخالفة النظافة والتطهير.', category: 'النظافة والصحة', unit: 'يوم' },
                    { id: 5, name: 'تقرير الفحص المخبري سلبي', value: 600, description: 'خصم لتقرير الفحص المخبري السلبي.', category: 'النظافة والصحة', unit: 'سلبي' }
                ],
                splashImageUrl: 'https://placehold.co/250x250/EAC696/ffffff?text=ABATTOIR+KPI',
                kpiImageUrl: 'https://placehold.co/250x250/EAC696/ffffff?text=KPI+IMAGE'
            },
            reports: [], // بيانات التقارير اليومية
            approvedReports: [], // التقارير المعتمدة
            monthlyReports: [], // التقارير الشهرية الجديدة
            notifications: [] // الإشعارات الجديدة
        };

        // تجميع المؤشرات حسب الفئة لسهولة بناء الجدول
        const KPI_CATEGORIES = {
            'الإدارة': [],
            'الذبح': [],
            'النظافة والصحة': [],
            'الصيانة': []
        };
        DATA.settings.kpis.forEach(kpi => {
            if (KPI_CATEGORIES[kpi.category]) {
                KPI_CATEGORIES[kpi.category].push(kpi);
            }
        });
        
        const mainContent = document.getElementById('main-content');
        const headerTitle = document.getElementById('header-title');
        const navbar = document.getElementById('navbar');
        const appHeader = document.getElementById('app-header');
        const appModalContainer = document.getElementById('appModal');

        // === 2. وظائف إدارة البيانات (Local Storage) ===

        function loadData() {
            try {
                const storedData = localStorage.getItem(LS_KEY);
                if (storedData) {
                    const loadedData = JSON.parse(storedData);
                    // دمج البيانات المحفوظة مع القيم الافتراضية
                    DATA.settings = { ...DATA.settings, ...loadedData.settings };
                    DATA.reports = loadedData.reports || [];
                    DATA.approvedReports = loadedData.approvedReports || [];
                    DATA.monthlyReports = loadedData.monthlyReports || [];
                    DATA.notifications = loadedData.notifications || [];
                }
            } catch (error) {
                console.error('Error loading data from Local Storage:', error);
            }
        }

        function saveData() {
            try {
                localStorage.setItem(LS_KEY, JSON.stringify(DATA));
            } catch (error) {
                console.error('Error saving data to Local Storage:', error);
            }
        }

        // === 3. وظائف التنقل وعرض الشاشات ===

        function navigate(screen, params = {}) {
            APP_STATE.currentScreen = screen;
            mainContent.innerHTML = '';
            appHeader.classList.remove('hidden');

            switch (screen) {
                case 'login':
                    appHeader.classList.add('hidden');
                    showLoginScreen();
                    break;
                case 'dashboard':
                    showDashboard();
                    break;
                case 'dailyEvaluation':
                    showDailyEvaluation(params.date);
                    break;
                case 'monthlyEvaluation': // شاشة جديدة للتقييم الشهري
                    showMonthlyEvaluation(params.monthYear, params.siteId);
                    break;
                case 'monthlyKPI':
                    showMonthlyKPI();
                    break;
                case 'monthlyReport':
                    showMonthlyReport();
                    break;
                case 'violations':
                    showViolations();
                    break;
                case 'monthlyInvoice':
                    showMonthlyInvoice();
                    break;
                case 'settings':
                    showSettings();
                    break;
                case 'userSignature':
                    showUserSignature();
                    break;
                default:
                    showDashboard();
            }
            saveCurrentState();
        }

        function setupHeaderAndNav(title) {
            headerTitle.textContent = title;
            navbar.innerHTML = '';

            // حساب عدد التقارير غير المعتمدة للإشعارات
            const pendingApprovalCount = getPendingApprovalCount();
            const notificationCount = getUnreadNotificationCount();

            const links = [
                { name: 'الرئيسية', screen: 'dashboard', roles: ['admin', 'user', 'approver', 'coordinator'] },
                { name: 'تقييم يومي', screen: 'dailyEvaluation', roles: ['admin', 'user'] },
                { name: 'تقييم شهري', screen: 'monthlyEvaluation', roles: ['admin', 'user'] }, // تم التعديل: لا تظهر للمعتمد والمنسق
                { 
                    name: 'مؤشر شهري', 
                    screen: 'monthlyKPI', 
                    roles: ['admin', 'user', 'approver', 'coordinator'],
                    notification: (APP_STATE.isApprover || APP_STATE.isCoordinator) ? pendingApprovalCount.kpi : 0
                },
                { 
                    name: 'التقرير الشهري', 
                    screen: 'monthlyReport', 
                    roles: ['admin', 'user', 'coordinator'],
                    notification: APP_STATE.isCoordinator ? pendingApprovalCount.monthly : 0
                },
                { 
                    name: 'المخالفات', 
                    screen: 'violations', 
                    roles: ['admin', 'user'],
                    notification: notificationCount.violations
                },
                { 
                    name: 'الفاتورة', 
                    screen: 'monthlyInvoice', 
                    roles: ['admin', 'user', 'approver', 'coordinator'],
                    notification: APP_STATE.isApprover ? pendingApprovalCount.invoice : 0
                },
                { name: 'توقيعي', screen: 'userSignature', roles: ['admin', 'user', 'approver', 'coordinator'] },
                { name: 'الإعدادات', screen: 'settings', roles: ['admin'] },
                { name: `تسجيل الخروج`, screen: 'login', roles: ['admin', 'user', 'approver', 'coordinator'], action: logout }
            ];

            links.filter(link => link.roles.includes(APP_STATE.loggedInUser.role)).forEach(link => {
                const button = document.createElement('button');
                button.className = 'app-btn p-2 text-sm relative';
                button.textContent = link.name;
                button.onclick = link.action || (() => navigate(link.screen));
                
                // إضافة إشعار إذا كان هناك تقارير بانتظار الاعتماد
                if (link.notification && link.notification > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = link.notification;
                    button.appendChild(badge);
                }
                
                navbar.appendChild(button);
            });
        }

        function getPendingApprovalCount() {
            const currentMonth = new Date().toISOString().substring(0, 7);
            const kpiPending = DATA.reports.filter(r => 
                r.date.startsWith(currentMonth) && 
                !DATA.approvedReports.some(ar => ar.reportId === r.id && ar.type === 'kpi')
            ).length;
            
            const invoicePending = DATA.reports.filter(r => 
                r.date.startsWith(currentMonth) && 
                !DATA.approvedReports.some(ar => ar.reportId === r.id && ar.type === 'invoice')
            ).length;
            
            const monthlyPending = DATA.monthlyReports.filter(r => 
                r.monthYear === currentMonth && 
                !r.isApproved
            ).length;
            
            return { kpi: kpiPending, invoice: invoicePending, monthly: monthlyPending };
        }

        function getUnreadNotificationCount() {
            const userNotifications = DATA.notifications.filter(n => 
                n.userId === APP_STATE.loggedInUser.id && !n.isRead
            );
            
            const violationsCount = userNotifications.filter(n => n.type === 'violation').length;
            const kpiCount = userNotifications.filter(n => n.type === 'kpi').length;
            const monthlyCount = userNotifications.filter(n => n.type === 'monthly').length;
            const invoiceCount = userNotifications.filter(n => n.type === 'invoice').length;
            
            return {
                violations: violationsCount,
                kpi: kpiCount,
                monthly: monthlyCount,
                invoice: invoiceCount,
                total: userNotifications.length
            };
        }

        function markNotificationsAsRead(type) {
            DATA.notifications.forEach(notification => {
                if (notification.userId === APP_STATE.loggedInUser.id && notification.type === type) {
                    notification.isRead = true;
                }
            });
            saveData();
        }

        function addNotification(userId, message, type) {
            const notification = {
                id: crypto.randomUUID(),
                userId: userId,
                message: message,
                type: type,
                isRead: false,
                createdAt: new Date().toISOString()
            };
            
            DATA.notifications.push(notification);
            saveData();
        }

        // وظيفة عرض رسائل النجاح العابرة (بديل للـ modal)
        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.className = 'success-toast';
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function logout() {
            APP_STATE.loggedInUser = null;
            APP_STATE.isAdmin = false;
            APP_STATE.isApprover = false;
            APP_STATE.isCoordinator = false;
            APP_STATE.currentSite = null;
            navigate('login');
        }

        // حفظ وتحميل حالة التطبيق
        function saveCurrentState() {
            const stateToSave = {
                currentScreen: APP_STATE.currentScreen,
                loggedInUserId: APP_STATE.loggedInUser ? APP_STATE.loggedInUser.id : null
            };
            localStorage.setItem('app_state', JSON.stringify(stateToSave));
        }

        function loadCurrentState() {
            const savedState = localStorage.getItem('app_state');
            if (savedState) {
                const state = JSON.parse(savedState);
                const user = DATA.settings.users.find(u => u.id === state.loggedInUserId);
                if (user) {
                    loginUser(user);
                    navigate(state.currentScreen);
                    return true;
                }
            }
            return false;
        }

        // === 4. شاشة الترحيب وتسجيل الدخول ===

        function showSplashScreen() {
            mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen">
                    <img src="${DATA.settings.splashImageUrl}" alt="شعار البرنامج" class="rounded-lg shadow-xl" style="width: 250px; height: 250px;">
                    <p class="mt-6 text-2xl text-amber-900 font-extrabold">برنامج مؤشر أداء المشغل</p>
                </div>
            `;
            setTimeout(() => {
                navigate('login');
            }, 1300);
        }

        function loginUser(user) {
            APP_STATE.loggedInUser = user;
            APP_STATE.isAdmin = user.role === 'admin';
            APP_STATE.isApprover = user.role === 'approver';
            APP_STATE.isCoordinator = user.role === 'coordinator';
            // إذا لم يكن أدمن، يتم تحديد موقعه المعني فقط
            APP_STATE.currentSite = DATA.settings.sites.find(s => APP_STATE.isAdmin ? s.id === (user.siteId || DATA.settings.sites[0]?.id) : s.id === user.siteId);
            APP_STATE.isAuthReady = true;
        }

        function showLoginScreen() {
            mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-screen">
                    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
                        <h2 class="text-3xl font-bold text-center mb-6 text-amber-800">تسجيل الدخول</h2>
                        <div class="mb-4">
                            <label for="employeeId" class="block text-sm font-medium text-gray-700 mb-2">الرقم الوظيفي</label>
                            <input type="number" id="employeeId" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 text-lg text-center" placeholder="أدخل رقمك الوظيفي" required>
                        </div>
                        <button id="loginBtn" class="app-btn w-full mt-4 text-lg">دخول</button>
                        <p id="loginMessage" class="mt-4 text-center text-red-600 hidden">الرقم الوظيفي غير صحيح أو غير موجود.</p>
                       
                    </div>
                </div>
            `;
            document.getElementById('loginBtn').addEventListener('click', () => {
                const id = document.getElementById('employeeId').value.trim();
                const user = DATA.settings.users.find(u => u.id === id);

                if (user) {
                    loginUser(user);
                    navigate('dashboard');
                } else {
                    document.getElementById('loginMessage').classList.remove('hidden');
                }
            });
        }

        // === 5. شاشة لوحة التحكم ===

        function showDashboard() {
            setupHeaderAndNav('لوحة التحكم');

            const allowedSites = APP_STATE.isAdmin ? DATA.settings.sites : [APP_STATE.currentSite];
            const siteInfo = allowedSites.map(site => `
                <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-amber-800">${site.name}</h3>
                    <p class="text-gray-600 mt-2">المشغل: ${site.operator}</p>
                    <p class="text-gray-600">رقم العقد: ${site.contract}</p>
                </div>
            `).join('');

            // إشعارات للمعتمد والمنسق
            const approvalNotifications = (APP_STATE.isApprover || APP_STATE.isCoordinator) ? `
                <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-2">إشعارات الاعتماد</h3>
                    <div class="space-y-2">
                        ${getPendingApprovalNotifications()}
                    </div>
                </div>
            ` : '';

            // إشعارات المستخدم
            const userNotifications = getUnreadNotificationCount().total > 0 ? `
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">إشعارات جديدة</h3>
                    <div class="space-y-2">
                        ${getUserNotifications()}
                    </div>
                </div>
            ` : '';

            mainContent.innerHTML = `
                <div class="space-y-8">
                    <h2 class="text-3xl font-extrabold text-amber-900">مرحباً بك، ${APP_STATE.loggedInUser.name}</h2>
                    
                    ${(APP_STATE.isApprover || APP_STATE.isCoordinator) ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${APP_STATE.isApprover ? `
                                <button onclick="navigate('monthlyKPI')" class="p-6 bg-amber-600 text-white rounded-xl shadow-xl hover:bg-amber-700 transition duration-300 text-2xl font-bold relative">
                                    عرض مؤشر الأداء الشهري
                                    ${getPendingApprovalCount().kpi > 0 ? `<span class="notification-badge">${getPendingApprovalCount().kpi}</span>` : ''}
                                </button>
                                <button onclick="navigate('monthlyInvoice')" class="p-6 bg-amber-600 text-white rounded-xl shadow-xl hover:bg-amber-700 transition duration-300 text-2xl font-bold relative">
                                    عرض الفاتورة الشهرية
                                    ${getPendingApprovalCount().invoice > 0 ? `<span class="notification-badge">${getPendingApprovalCount().invoice}</span>` : ''}
                                </button>
                            ` : ''}
                            ${APP_STATE.isCoordinator ? `
                                <button onclick="navigate('monthlyReport')" class="p-6 bg-amber-600 text-white rounded-xl shadow-xl hover:bg-amber-700 transition duration-300 text-2xl font-bold relative">
                                    عرض التقرير الشهري
                                    ${getPendingApprovalCount().monthly > 0 ? `<span class="notification-badge">${getPendingApprovalCount().monthly}</span>` : ''}
                                </button>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <button onclick="navigate('dailyEvaluation')" class="p-6 bg-amber-600 text-white rounded-xl shadow-xl hover:bg-amber-700 transition duration-300 text-2xl font-bold">بدء تقييم يومي</button>
                            <button onclick="navigate('monthlyEvaluation')" class="p-6 bg-amber-600 text-white rounded-xl shadow-xl hover:bg-amber-700 transition duration-300 text-2xl font-bold">التقييم الشهري</button>
                            <button onclick="navigate('violations')" class="p-6 bg-amber-600 text-white rounded-xl shadow-xl hover:bg-amber-700 transition duration-300 text-2xl font-bold">مخالفات المقاول</button>
                        </div>
                    `}

                    <h3 class="text-2xl font-semibold text-amber-800 border-b pb-2">المواقع المخصصة لك</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${siteInfo}
                    </div>
                    
                    ${approvalNotifications}
                    ${userNotifications}
                </div>
            `;
        }

        function getPendingApprovalNotifications() {
            const currentMonth = new Date().toISOString().substring(0, 7);
            const pendingKPI = DATA.reports.filter(r => 
                r.date.startsWith(currentMonth) && 
                !DATA.approvedReports.some(ar => ar.reportId === r.id && ar.type === 'kpi')
            );
            
            const pendingInvoices = DATA.reports.filter(r => 
                r.date.startsWith(currentMonth) && 
                !DATA.approvedReports.some(ar => ar.reportId === r.id && ar.type === 'invoice')
            );
            
            const pendingMonthly = DATA.monthlyReports.filter(r => 
                r.monthYear === currentMonth && 
                !r.isApproved
            );
            
            let notifications = '';
            
            if (APP_STATE.isApprover) {
                if (pendingKPI.length > 0) {
                    notifications += `<p class="text-yellow-700">• لديك ${pendingKPI.length} تقرير أداء شهري بانتظار الاعتماد</p>`;
                }
                
                if (pendingInvoices.length > 0) {
                    notifications += `<p class="text-yellow-700">• لديك ${pendingInvoices.length} فاتورة شهرية بانتظار الاعتماد</p>`;
                }
            }
            
            if (APP_STATE.isCoordinator && pendingMonthly.length > 0) {
                notifications += `<p class="text-yellow-700">• لديك ${pendingMonthly.length} تقرير شهري بانتظار الاعتماد</p>`;
            }
            
            if (notifications === '') {
                notifications = '<p class="text-green-700">• لا توجد تقارير بانتظار الاعتماد</p>';
            }
            
            return notifications;
        }

        function getUserNotifications() {
            const userNotifications = DATA.notifications.filter(n => 
                n.userId === APP_STATE.loggedInUser.id && !n.isRead
            );
            
            if (userNotifications.length === 0) {
                return '<p class="text-green-700">• لا توجد إشعارات جديدة</p>';
            }
            
            return userNotifications.map(notification => 
                `<p class="text-blue-700">• ${notification.message}</p>`
            ).join('');
        }

        // === 6. شاشة التقييم اليومي ===
        
        // وظيفة مساعدة لإيجاد تقرير ليوم معين وموقع معين
        function getReport(date, siteId) {
            return DATA.reports.find(r => r.date === date && r.siteId === siteId);
        }

        function showDailyEvaluation(date = new Date().toISOString().split('T')[0]) {
            setupHeaderAndNav('التقييم اليومي');
            APP_STATE.currentReportDate = date;

            const site = APP_STATE.currentSite; // الموقع المخصص للمستخدم الحالي
            const currentReport = getReport(date, site.id);
            
            // التحقق من وجود تقرير مسبق لنفس اليوم ونفس الموقع
            // تم تعديل الشرط: لا يتم إغلاق الشاشة أو منع التقييم إذا كان هناك تقرير مسبق
            const isAlreadySubmitted = currentReport ? true : false;
            
            const notes = currentReport ? currentReport.notes : '';
            
            // تهيئة المخالفات، إذا كان هناك تقرير سابق نستخدم مخالفاته، وإلا نبدأ بقائمة فارغة
            const existingViolations = currentReport ? currentReport.violations : [];

            const siteStaff = site.staff;
            const kpiIndicators = DATA.settings.kpis;
            
            // بداية الحل لمشكلة التنسيق: إضافة div لتغليف الجدول وضمان التمرير الأفقي
            let tableHTML = `
                <div class="overflow-x-auto rounded-lg shadow-xl border border-gray-300">
                <table class="min-w-max bg-white table-auto">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-3 px-4 border-b text-right text-sm font-semibold text-gray-700 sticky right-0 bg-gray-100 z-[5]" style="min-width: 150px;">مؤشر التقييم</th>
            `;

            // إضافة أعمدة لكل عامل مع اسمه ووظيفته
            siteStaff.forEach(staff => {
                const bgColorClass = staff.role === 'مشرف' ? 'bg-supervisor' :
                                     staff.role === 'محاسب' ? 'bg-accountant' :
                                     staff.role === 'مراقب' ? 'bg-supervisor' :
                                     staff.role === 'قصاب' ? 'bg-butcher' :
                                     staff.role === 'عامل نظافة' ? 'bg-cleaner' :
                                     staff.role === 'حمال' ? 'bg-cleaner' : 'bg-gray-200';
                tableHTML += `<th class="py-3 px-4 border-b text-center text-sm font-semibold text-gray-700 ${bgColorClass}" style="min-width: 120px;">${staff.name}<br>(${staff.role})</th>`;
            });

            tableHTML += `
                        </tr>
                    </thead>
                    <tbody id="evaluation-body">
            `;

            kpiIndicators.forEach((kpi, kpiIndex) => {
                const kpiName = kpi.name;
                const requiredWorkers = kpi.workers;
                
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="py-3 px-4 border-b text-right font-medium text-gray-800 sticky right-0 bg-white" style="min-width: 150px;">${kpiName}</td>
                `;

                siteStaff.forEach(staff => {
                    const isRequired = requiredWorkers.includes(staff.role);
                    
                    // لا نضع مربعات اختيار إذا كان العامل غير مطلوب لهذا المؤشر
                    if (!isRequired) {
                        tableHTML += `<td class="py-3 px-4 border-b text-center text-gray-400">-</td>`;
                    } else {
                        const workerKey = staff.id;
                        const oldKpiIndex = DATA.settings.kpis.findIndex(k => k.name === kpiName);
                        const isChecked = currentReport ? (currentReport.scores[oldKpiIndex]?.[workerKey] || false) : true;
                        
                        tableHTML += `
                            <td class="py-3 px-4 border-b text-center">
                                <div class="flex items-center justify-center p-1">
                                    <input type="checkbox" data-kpi-index="${oldKpiIndex}" data-worker-key="${workerKey}" data-kpi-category="${kpi.category}"
                                        class="form-checkbox h-5 w-5 text-amber-600 rounded" ${isChecked ? 'checked' : ''}>
                                </div>
                            </td>
                        `;
                    }
                });

                tableHTML += `</tr>`;
            });

            tableHTML += `
                    </tbody>
                </table>
                </div>
                <div class="mt-6">
                    <h3 class="text-xl font-semibold text-amber-800 mb-3">ملاحظات يومية</h3>
                    <textarea id="dailyNotes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="سجل الملاحظات اليومية هنا">${notes}</textarea>
                </div>

                <div class="mt-6 p-4 border border-red-300 bg-red-50 rounded-lg">
                    <h3 class="text-xl font-semibold text-red-700 mb-3">تسجيل مخالفات المقاول</h3>
                    <div id="violation-list" class="space-y-3">
                        <!-- قائمة المخالفات المسجلة حالياً -->
                    </div>
                    <button onclick="addViolationRow()" class="mt-3 app-btn bg-red-500 hover:bg-red-600 text-sm">إضافة مخالفة جديدة</button>
                    <p id="violation-warning" class="mt-4 text-red-600 font-medium hidden">⚠️ لا يمكن تقديم التقرير بنسبة أداء أقل من 100% دون تسجيل مخالفة أو كتابة ملاحظة دون أي إجراء.</p>
                </div>

                <div class="mt-8 relative flex justify-between space-x-4 space-x-reverse">
                    <button onclick="navigate('dashboard')" class="app-btn bg-gray-500 hover:bg-gray-600">رجوع</button>
                    <button id="monthlyKPIBtn" onclick="navigate('monthlyKPI')" class="app-btn bg-amber-500 hover:bg-amber-600">مؤشر الأداء الشهري</button>
                    <button id="submitReportBtn" class="app-btn bg-green-600 hover:bg-green-700">${isAlreadySubmitted ? 'تحديث التقييم' : 'تقديم التقييم'}</button>
                </div>
            `;

            mainContent.innerHTML = `
                <div class="space-y-6">
                    <div class="flex flex-wrap items-center justify-between mb-4 p-4 bg-amber-50 rounded-xl shadow-md">
                        <p class="text-lg font-medium text-amber-800">الموقع: <b>${site.name}</b></p>
                        <p class="text-lg font-medium text-amber-800">المقاول: <b>${site.operator}</b></p>
                        <label class="flex items-center space-x-2 space-x-reverse text-lg font-medium text-amber-800">
                            التاريخ:
                            <input type="date" id="reportDate" value="${date}" onchange="changeReportDate(this.value)" class="p-2 border rounded-lg">
                        </label>
                    </div>
                    ${isAlreadySubmitted ? `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg font-semibold">⚠️ تم تقديم تقييم لهذا اليوم مسبقاً. يمكنك تعديله إذا لزم الأمر.</div>` : ''}
                    ${tableHTML}
                </div>
            `;

            // عرض المخالفات المسجلة مسبقاً
            const violationList = document.getElementById('violation-list');
            existingViolations.forEach(v => {
                violationList.innerHTML += createViolationRow(v.violationId, v.notes || '', v.id);
            });

            // ربط زر التقديم بالوظيفة
            document.getElementById('submitReportBtn').addEventListener('click', handleSubmitReport);
        }

        function changeReportDate(newDate) {
            APP_STATE.currentReportDate = newDate;
            navigate('dailyEvaluation', { date: newDate });
        }

        function createViolationRow(violationId, notes = '', uniqueId = crypto.randomUUID()) {
            const violation = DATA.settings.violations.find(v => v.id == violationId) || {};
            const violationOptions = DATA.settings.violations.map(v => 
                `<option value="${v.id}" ${v.id == violationId ? 'selected' : ''}>${v.name} (خصم: ${v.value} درهم)</option>`
            ).join('');

            return `
                <div class="flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-4 md:space-x-reverse p-3 border border-red-200 bg-white rounded-lg violation-row" data-violation-id="${violationId}" data-unique-id="${uniqueId}">
                    <select class="w-full md:w-1/3 p-2 border rounded-lg text-sm text-red-800 font-medium">
                        ${violationOptions}
                    </select>
                    <textarea class="w-full md:w-2/3 p-2 border rounded-lg text-sm" placeholder="ملاحظة خاصة بالمخالفة (اختياري)">${notes}</textarea>
                    <button onclick="removeViolationRow(this)" class="app-btn bg-red-400 hover:bg-red-500 p-2 text-xs flex-shrink-0">حذف</button>
                </div>
            `;
        }

        function addViolationRow() {
            const violationList = document.getElementById('violation-list');
            const newViolationId = DATA.settings.violations[0]?.id || 1; 
            violationList.innerHTML += createViolationRow(newViolationId);
        }

        function removeViolationRow(btn) {
            btn.closest('.violation-row').remove();
        }

        function calculateDailyKPI() {
            const checkboxes = mainContent.querySelectorAll('#evaluation-body input[type="checkbox"]');
            let totalPossibleScore = 0;
            let actualScore = 0;

            const scores = {};
            const siteStaff = APP_STATE.currentSite.staff;
            
            // حساب العدد الكلي للنقاط الممكنة (عدد المؤشرات * عدد العمال المعنيين)
            DATA.settings.kpis.forEach((kpi, kpiIndex) => {
                kpi.workers.forEach(requiredRole => {
                    siteStaff.forEach(staff => {
                        if (staff.role === requiredRole) {
                            totalPossibleScore++;
                        }
                    });
                });
            });

            // حساب النقاط الفعلية
            checkboxes.forEach(cb => {
                const kpiIndex = parseInt(cb.dataset.kpiIndex);
                const workerKey = cb.dataset.workerKey;

                if (!scores[kpiIndex]) scores[kpiIndex] = {};

                if (cb.checked) {
                    actualScore++;
                    scores[kpiIndex][workerKey] = true;
                } else {
                    scores[kpiIndex][workerKey] = false;
                }
            });

            const percentage = totalPossibleScore > 0 ? (actualScore / totalPossibleScore) * 100 : 0;
            return { percentage, scores, totalPossibleScore, actualScore };
        }

        // وظيفة جديدة لاكتشاف أسباب انخفاض الأداء
        function detectPerformanceIssues(scores, siteStaff) {
            const issues = [];
            
            DATA.settings.kpis.forEach((kpi, kpiIndex) => {
                const kpiWorkers = kpi.workers.filter(w => siteStaff.some(s => s.role === w));
                let kpiScore = 0;
                let kpiPossible = 0;
                
                kpiWorkers.forEach(requiredRole => {
                    siteStaff.forEach(staff => {
                        if (staff.role === requiredRole) {
                            kpiPossible++;
                            const workerKey = staff.id;
                            if (scores[kpiIndex] && scores[kpiIndex][workerKey]) {
                                kpiScore++;
                            }
                        }
                    });
                });
                
                const kpiPercentage = kpiPossible > 0 ? (kpiScore / kpiPossible) * 100 : 100;
                
                // إذا كان أداء المؤشر أقل من 100%
                if (kpiPercentage < 100) {
                    // العثور على المخالفة المناسبة لهذا النوع من المؤشرات
                    const relatedViolation = DATA.settings.violations.find(v => v.category === kpi.category);
                    if (relatedViolation && !issues.some(issue => issue.violationId === relatedViolation.id)) {
                        issues.push({
                            violationId: relatedViolation.id,
                            name: relatedViolation.name,
                            value: relatedViolation.value,
                            category: kpi.category,
                            kpiName: kpi.name,
                            percentage: kpiPercentage
                        });
                    }
                }
            });
            
            return issues;
        }

        function handleSubmitReport() {
            const { percentage, scores } = calculateDailyKPI();
            const dailyNotes = document.getElementById('dailyNotes').value.trim();
            const currentSiteId = APP_STATE.currentSite.id;
            const reportDate = APP_STATE.currentReportDate;

            const violationRows = mainContent.querySelectorAll('.violation-row');
            const newViolations = Array.from(violationRows).map(row => {
                const selectedViolationId = row.querySelector('select').value;
                const notes = row.querySelector('textarea').value;
                const violationData = DATA.settings.violations.find(v => v.id == selectedViolationId) || {};

                return {
                    id: row.dataset.uniqueId,
                    violationId: parseInt(selectedViolationId),
                    name: violationData.name,
                    value: violationData.value,
                    notes: notes,
                    isClosed: false,
                    reportDate: reportDate,
                    siteId: currentSiteId,
                };
            });

            // إذا كان الأداء أقل من 100%، نكتشف المخالفات تلقائياً
            if (percentage < 100) {
                const detectedIssues = detectPerformanceIssues(scores, APP_STATE.currentSite.staff);
                
                detectedIssues.forEach(issue => {
                    // التأكد من عدم وجود المخالفة مسبقاً
                    if (!newViolations.some(v => v.violationId === issue.violationId)) {
                        newViolations.push({
                            id: crypto.randomUUID(),
                            violationId: issue.violationId,
                            name: issue.name,
                            value: issue.value,
                            notes: `مخالفة تلقائية بسبب انخفاض أداء ${issue.kpiName} (${issue.percentage.toFixed(1)}%)`,
                            isClosed: false,
                            reportDate: reportDate,
                            siteId: currentSiteId,
                        });
                    }
                });
            }

            // شرط التقديم الإجباري
            const warningEl = document.getElementById('violation-warning');
            if (percentage < 100 && newViolations.length === 0 && dailyNotes !== 'ملاحظة دون أي اجراء') {
                warningEl.classList.remove('hidden');
                return;
            } else {
                warningEl.classList.add('hidden');
            }

            // إنشاء/تحديث التقرير
            const reportIndex = DATA.reports.findIndex(r => r.date === reportDate && r.siteId === currentSiteId);

            const reportData = {
                id: reportIndex !== -1 ? DATA.reports[reportIndex].id : crypto.randomUUID(),
                userId: APP_STATE.loggedInUser.id,
                userName: APP_STATE.loggedInUser.name,
                siteId: currentSiteId,
                date: reportDate,
                notes: dailyNotes,
                scores: scores,
                kpiPercentage: percentage.toFixed(2),
                violations: newViolations,
                isSubmitted: true,
                submittedAt: new Date().toISOString()
            };

            if (reportIndex !== -1) {
                DATA.reports[reportIndex] = reportData;
                showSuccessToast('تم تحديث التقييم بنجاح');
            } else {
                DATA.reports.push(reportData);
                showSuccessToast('تم تقديم التقييم بنجاح');
            }

            saveData();
            
            // إضافة إشعارات للمعتمدين والمنسقين
            if (newViolations.length > 0) {
                const approverUsers = DATA.settings.users.filter(u => u.role === 'approver');
                const coordinatorUsers = DATA.settings.users.filter(u => u.role === 'coordinator');
                
                approverUsers.forEach(user => {
                    addNotification(user.id, `تم إضافة ${newViolations.length} مخالفة جديدة في ${APP_STATE.currentSite.name} تحتاج إلى مراجعة`, 'violation');
                });
                
                coordinatorUsers.forEach(user => {
                    addNotification(user.id, `تم إضافة ${newViolations.length} مخالفة جديدة في ${APP_STATE.currentSite.name} تحتاج إلى مراجعة`, 'violation');
                });
            }
        }

        // === 7. شاشة التقييم الشهري الجديدة ===

        function showMonthlyEvaluation(monthYear = new Date().toISOString().substring(0, 7), siteId = null) {
            setupHeaderAndNav('التقييم الشهري');

            const sitesToView = APP_STATE.isAdmin ? DATA.settings.sites : [APP_STATE.currentSite];
            const selectedSiteId = siteId || (APP_STATE.isAdmin ? sitesToView[0].id : APP_STATE.currentSite.id);

            let contentHTML = `
                <div class="space-y-6">
                    <h2 class="text-3xl font-extrabold text-amber-900">التقييم الشهري</h2>
                    
                    <div class="flex flex-wrap items-center space-x-4 space-x-reverse gap-4 p-4 bg-amber-50 rounded-xl shadow-md">
                        ${APP_STATE.isAdmin ? `
                            <label for="site-select-monthly-eval" class="font-semibold text-amber-800">اختر المسلخ:</label>
                            <select id="site-select-monthly-eval" class="p-2 border rounded-lg" onchange="renderMonthlyEvaluation(this.value, document.getElementById('month-select-monthly-eval').value)">
                                ${sitesToView.map(s => `<option value="${s.id}" ${s.id === selectedSiteId ? 'selected' : ''}>${s.name}</option>`).join('')}
                            </select>
                        ` : `<input type="hidden" id="site-select-monthly-eval" value="${selectedSiteId}">`}

                        <label for="month-select-monthly-eval" class="font-semibold text-amber-800">اختر الشهر:</label>
                        <input type="month" id="month-select-monthly-eval" value="${monthYear}" class="p-2 border rounded-lg" onchange="renderMonthlyEvaluation(document.getElementById('site-select-monthly-eval').value, this.value)">
                        <button onclick="saveMonthlyEvaluationChanges()" class="app-btn bg-green-600 text-sm">حفظ التغييرات</button>
                    </div>

                    <div id="monthly-evaluation-content" class="bg-white p-6 rounded-xl shadow-2xl overflow-x-auto">
                        <!-- محتوى التقييم الشهري يظهر هنا -->
                    </div>
                </div>
            `;
            mainContent.innerHTML = contentHTML;

            renderMonthlyEvaluation(selectedSiteId, monthYear);
        }

        function renderMonthlyEvaluation(siteId, monthYear) {
            const site = DATA.settings.sites.find(s => s.id === siteId);
            const siteStaff = site.staff;
            const kpiIndicators = DATA.settings.kpis;

            // الحصول على جميع تقارير الشهر المحدد
            const monthlyReports = DATA.reports.filter(r => 
                r.siteId === siteId && 
                r.date.startsWith(monthYear)
            ).sort((a, b) => new Date(a.date) - new Date(b.date));

            // حساب عدد أيام الشهر
            const year = parseInt(monthYear.split('-')[0]);
            const month = parseInt(monthYear.split('-')[1]);
            const daysInMonth = new Date(year, month, 0).getDate();

            let tableHTML = `
                <div class="overflow-x-auto">
                <table class="monthly-evaluation-table">
                    <thead>
                        <tr>
                            <th rowspan="2" class="kpi-name">مؤشر التقييم</th>
                            <th rowspan="2" class="staff-name">القوى العاملة</th>
            `;

            // إضافة أعمدة للأيام
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${monthYear}-${day.toString().padStart(2, '0')}`;
                const report = monthlyReports.find(r => r.date === dateStr);
                const hasReport = !!report;
                const dateObj = new Date(dateStr);
                const dayName = dateObj.toLocaleDateString('ar-SA', { weekday: 'short' });
                
                tableHTML += `
                    <th class="text-center" title="${dateStr}">
                        ${day}<br>${dayName}
                    </th>
                `;
            }

            tableHTML += `
                        </tr>
                        <tr>
            `;

            // إضافة أعمدة للمدخلين
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${monthYear}-${day.toString().padStart(2, '0')}`;
                const report = monthlyReports.find(r => r.date === dateStr);
                const userName = report ? report.userName : '-';
                
                tableHTML += `
                    <th class="text-center text-xs bg-gray-100">
                        ${userName}
                    </th>
                `;
            }

            tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
            `;

            // إضافة صفوف لكل مؤشر وعامل
            kpiIndicators.forEach((kpi, kpiIndex) => {
                const kpiName = kpi.name;
                const requiredWorkers = kpi.workers;
                
                requiredWorkers.forEach(requiredRole => {
                    siteStaff.forEach(staff => {
                        if (staff.role === requiredRole) {
                            tableHTML += `
                                <tr>
                                    <td class="kpi-name">${kpiName}</td>
                                    <td class="staff-name">${staff.name} (${staff.role})</td>
                            `;

                            // إضافة خانات لكل يوم
                            for (let day = 1; day <= daysInMonth; day++) {
                                const dateStr = `${monthYear}-${day.toString().padStart(2, '0')}`;
                                const report = monthlyReports.find(r => r.date === dateStr);
                                const isChecked = report ? (report.scores[kpiIndex]?.[staff.id] || false) : false;
                                const isDisabled = !report; // تعطيل إذا لم يكن هناك تقرير
                                
                                tableHTML += `
                                    <td class="text-center">
                                        ${isDisabled ? 
                                            `<span class="text-gray-400">-</span>` : 
                                            `<input type="checkbox" 
                                                data-date="${dateStr}" 
                                                data-kpi-index="${kpiIndex}" 
                                                data-worker-id="${staff.id}"
                                                class="form-checkbox h-4 w-4 text-amber-600 rounded" 
                                                ${isChecked ? 'checked' : ''}>`
                                        }
                                    </td>
                                `;
                            }

                            tableHTML += `</tr>`;
                        }
                    });
                });
            });

            tableHTML += `
                    </tbody>
                </table>
                </div>
            `;

            document.getElementById('monthly-evaluation-content').innerHTML = tableHTML;
        }

        function saveMonthlyEvaluationChanges() {
            const siteId = document.getElementById('site-select-monthly-eval').value;
            const monthYear = document.getElementById('month-select-monthly-eval').value;
            
            // جمع جميع التغييرات
            const checkboxes = document.querySelectorAll('#monthly-evaluation-content input[type="checkbox"]');
            const changes = {};
            
            checkboxes.forEach(cb => {
                const date = cb.dataset.date;
                const kpiIndex = parseInt(cb.dataset.kpiIndex);
                const workerId = cb.dataset.workerId;
                const isChecked = cb.checked;
                
                if (!changes[date]) {
                    changes[date] = {};
                }
                
                if (!changes[date][kpiIndex]) {
                    changes[date][kpiIndex] = {};
                }
                
                changes[date][kpiIndex][workerId] = isChecked;
            });
            
            // تطبيق التغييرات على البيانات
            Object.keys(changes).forEach(date => {
                const reportIndex = DATA.reports.findIndex(r => r.date === date && r.siteId === siteId);
                
                if (reportIndex !== -1) {
                    // تحديث التقرير الموجود
                    Object.keys(changes[date]).forEach(kpiIndex => {
                        DATA.reports[reportIndex].scores[kpiIndex] = {
                            ...DATA.reports[reportIndex].scores[kpiIndex],
                            ...changes[date][kpiIndex]
                        };
                    });
                    
                    // إعادة حساب نسبة الأداء
                    const report = DATA.reports[reportIndex];
                    const site = DATA.settings.sites.find(s => s.id === siteId);
                    const { percentage } = calculateKPIForReport(report, site);
                    report.kpiPercentage = percentage.toFixed(2);
                }
            });
            
            saveData();
            showSuccessToast('تم حفظ التغييرات بنجاح');
        }

        function calculateKPIForReport(report, site) {
            let totalPossibleScore = 0;
            let actualScore = 0;

            // حساب العدد الكلي للنقاط الممكنة (عدد المؤشرات * عدد العمال المعنيين)
            DATA.settings.kpis.forEach((kpi, kpiIndex) => {
                kpi.workers.forEach(requiredRole => {
                    site.staff.forEach(staff => {
                        if (staff.role === requiredRole) {
                            totalPossibleScore++;
                            const workerKey = staff.id;
                            if (report.scores[kpiIndex] && report.scores[kpiIndex][workerKey]) {
                                actualScore++;
                            }
                        }
                    });
                });
            });

            const percentage = totalPossibleScore > 0 ? (actualScore / totalPossibleScore) * 100 : 0;
            return { percentage, totalPossibleScore, actualScore };
        }

        // === 8. شاشة المخالفات ===

        function showViolations() {
            setupHeaderAndNav('شاشة مخالفات المقاول');
            markNotificationsAsRead('violation');

            let allViolations = DATA.reports.flatMap(r => r.violations.map(v => ({
                ...v,
                reportId: r.id,
                reportDate: r.date,
                siteName: DATA.settings.sites.find(s => s.id === r.siteId)?.name || 'غير معروف',
            })));

            // تصفية حسب صلاحية المستخدم
            if (!APP_STATE.isAdmin) {
                allViolations = allViolations.filter(v => v.siteId === APP_STATE.loggedInUser.siteId);
            }
            
            // ترتيب المخالفات (المفتوحة أولاً)
            allViolations.sort((a, b) => a.isClosed - b.isClosed);

            const openViolations = allViolations.filter(v => !v.isClosed);

            const renderViolationsTable = (violations) => {
                if (violations.length === 0) {
                    return `<p class="text-center text-gray-500 py-4">لا توجد مخالفات في النظام حسب صلاحياتك.</p>`;
                }
                return `
                    <div class="overflow-x-auto">
                    <table class="min-w-max bg-white border border-gray-300 rounded-lg overflow-hidden shadow-md">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="py-3 px-4 border-b text-right">التاريخ</th>
                                <th class="py-3 px-4 border-b text-right">الموقع</th>
                                <th class="py-3 px-4 border-b text-right">المخالفة</th>
                                <th class="py-3 px-4 border-b text-right">قيمة الخصم</th>
                                <th class="py-3 px-4 border-b text-right">الحالة</th>
                                <th class="py-3 px-4 border-b text-center">الإجراء</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${violations.map(v => {
                                const status = v.isClosed ? 'مغلقة' : 'مفتوحة';
                                const statusClass = v.isClosed ? 'text-green-600' : 'text-red-600 font-bold';
                                return `
                                    <tr class="hover:bg-gray-50 ${v.isClosed ? 'opacity-75' : ''}">
                                        <td class="py-2 px-4 border-b">${v.reportDate}</td>
                                        <td class="py-2 px-4 border-b">${v.siteName}</td>
                                        <td class="py-2 px-4 border-b font-medium text-red-700">${v.name}</td>
                                        <td class="py-2 px-4 border-b">${v.value.toLocaleString('ar-EG')}</td>
                                        <td class="py-2 px-4 border-b ${statusClass}">${status}</td>
                                        <td class="py-2 px-4 border-b text-center">
                                            ${!v.isClosed ?
                                                `<button onclick="closeViolation('${v.reportId}', '${v.id}')" class="app-btn bg-green-500 hover:bg-green-600 p-2 text-sm">إغلاق ومعالجة</button>`
                                                : `-`}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    </div>
                `;
            };

            const notification = openViolations.length > 0 ?
                `<div class="p-4 bg-red-100 text-red-800 rounded-lg font-semibold mb-4">⚠️ لديك ${openViolations.length} مخالفة مفتوحة تتطلب المعالجة.</div>` :
                `<div class="p-4 bg-green-100 text-green-800 rounded-lg font-semibold mb-4">لا توجد مخالفات مفتوحة حالياً.</div>`;

            mainContent.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-3xl font-extrabold text-amber-900">إدارة مخالفات المقاول</h2>
                    ${notification}

                    <div class="space-y-4">
                        <h3 class="text-2xl font-semibold text-amber-800 border-b pb-2">قائمة المخالفات (تظهر فقط التي تم رصدها)</h3>
                        ${renderViolationsTable(allViolations)}
                    </div>
                </div>
            `;
        }

        function closeViolation(reportId, violationId) {
            const report = DATA.reports.find(r => r.id === reportId);
            if (report) {
                const violation = report.violations.find(v => v.id === violationId);
                if (violation) {
                    violation.isClosed = true;
                    saveData();
                    showSuccessToast('تم إغلاق المخالفة بنجاح وستخصم من الفاتورة الشهرية.');
                    navigate('violations');
                    return;
                }
            }
            showModal('خطأ', 'لم يتم العثور على المخالفة لإغلاقها.', 'violations');
        }

        // === 9. شاشة مؤشر الأداء الشهري ===

        function showMonthlyKPI() {
            setupHeaderAndNav('مؤشر الأداء الشهري');
            markNotificationsAsRead('kpi');

            const isApprover = APP_STATE.isApprover;
            const sitesToView = APP_STATE.isAdmin || isApprover || APP_STATE.isCoordinator ? DATA.settings.sites : [APP_STATE.currentSite];

            let contentHTML = `
                <div class="space-y-6">
                    <h2 class="text-3xl font-extrabold text-amber-900">تقرير مؤشر الأداء الشهري</h2>
                    
                    <div class="flex flex-wrap items-center space-x-4 space-x-reverse gap-4 p-4 bg-amber-50 rounded-xl shadow-md">
                        ${(APP_STATE.isAdmin || isApprover || APP_STATE.isCoordinator) ? `
                            <label for="site-select-kpi" class="font-semibold text-amber-800">اختر المسلخ:</label>
                            <select id="site-select-kpi" class="p-2 border rounded-lg" onchange="renderKPIReport(this.value, document.getElementById('month-select-kpi').value)">
                                ${sitesToView.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                        ` : `<input type="hidden" id="site-select-kpi" value="${APP_STATE.currentSite.id}">`}

                        <label for="month-select-kpi" class="font-semibold text-amber-800">اختر الشهر:</label>
                        <input type="month" id="month-select-kpi" value="${new Date().toISOString().substring(0, 7)}" class="p-2 border rounded-lg" onchange="renderKPIReport(document.getElementById('site-select-kpi').value, this.value)">
                        <button onclick="exportKPIReportToPDF()" class="app-btn text-sm">تصدير التقرير (PDF)</button>
                        ${APP_STATE.isApprover ? `<button onclick="approveKPIReport()" class="app-btn bg-green-600 text-sm">اعتماد التقرير</button>` : ''}
                        ${!APP_STATE.isApprover && !APP_STATE.isCoordinator ? `<button onclick="submitKPIReport()" class="app-btn bg-blue-600 text-sm">تقديم للاعتماد</button>` : ''}
                    </div>

                    <div id="kpi-report-content" class="bg-white p-6 rounded-xl shadow-2xl overflow-x-auto">
                        <!-- محتوى التقرير يظهر هنا -->
                    </div>
                </div>
            `;
            mainContent.innerHTML = contentHTML;

            const initialSiteId = sitesToView[0].id;
            renderKPIReport(initialSiteId, document.getElementById('month-select-kpi').value);
        }

        // دالة مساعدة لحساب متوسط KPI لفئة معينة
        function calculateCategoryKPI(reports, kpisInCategory, siteStaff) {
            let categoryTotalScore = 0;
            let categoryPossibleScore = 0;
            let totalDays = reports.length;

            if (totalDays === 0) return 0;

            reports.forEach(report => {
                kpisInCategory.forEach(kpi => {
                    const kpiIndex = DATA.settings.kpis.findIndex(k => k.name === kpi.name);
                    
                    kpi.workers.forEach(requiredRole => {
                        siteStaff.forEach(staff => {
                            if (staff.role === requiredRole) {
                                categoryPossibleScore++;
                                const workerKey = staff.id;
                                if (report.scores[kpiIndex] && report.scores[kpiIndex][workerKey]) {
                                    categoryTotalScore++;
                                }
                            }
                        });
                    });
                });
            });

            return categoryPossibleScore > 0 ? ((categoryTotalScore / categoryPossibleScore) * 100).toFixed(2) : '100.00';
        }

        function renderKPIReport(siteId, monthYear) {
            const site = DATA.settings.sites.find(s => s.id === siteId);
            const siteStaff = site.staff;

            const filteredReports = DATA.reports.filter(r =>
                r.siteId === siteId &&
                r.date.startsWith(monthYear)
            );
            const totalDays = filteredReports.length;
            const operatorName = site.operator;
            
            // الحصول على اسم المستخدم المدخل للبيانات في آخر يوم من الشهر
            const lastDayOfMonth = new Date(new Date(monthYear).getFullYear(), new Date(monthYear).getMonth() + 1, 0).getDate();
            const lastDayReport = filteredReports
                .filter(r => r.date === `${monthYear}-${lastDayOfMonth.toString().padStart(2, '0')}`)
                .pop();
            const dataEntryUser = lastDayReport ? lastDayReport.userName : 'غير معروف';
            
            // الحصول على توقيع المدخل
            const dataEntryUserObj = DATA.settings.users.find(u => u.name === dataEntryUser);
            const dataEntryUserSignature = dataEntryUserObj ? dataEntryUserObj.signature : null;
            
            // التحقق مما إذا كان التقرير معتمداً
            const isApproved = DATA.approvedReports.some(ar => 
                ar.siteId === siteId && 
                ar.monthYear === monthYear && 
                ar.type === 'kpi'
            );
            
            // الحصول على توقيع المعتمد
            const approverUser = DATA.settings.users.find(u => u.role === 'approver');
            const approverSignature = isApproved ? approverUser.signature : null;
            
            let totalOverallPercentage = 0;
            let totalCategories = 0;
            let tableHTML = '';

            tableHTML += `
                <div id="kpi-report-printable" class="p-2 border-2 border-amber-800 rounded-lg bg-white shadow-xl relative" style="min-width: 1000px;">
                    <div class="flex justify-between items-center mb-4">
                        <img src="${DATA.settings.kpiImageUrl}" alt="صورة المؤشر" class="w-32 h-32 rounded-lg">
                        <h3 class="text-3xl font-extrabold text-center text-amber-900 my-4">المؤشرات الرئيسية للأداء</h3>
                        <div></div>
                    </div>
                    <div class="flex justify-between items-center text-sm mb-4 border-b pb-2 font-medium">
                        <p>المسلخ: <span class="text-amber-700 font-bold">${site.name}</span></p>
                        <p>المقاول: <span class="text-amber-700 font-bold">${operatorName}</span></p>
                        <p>الشهر: <span class="text-amber-700 font-bold">${monthYear}</span></p>
                        <p>عدد التقارير اليومية المدخلة: <span class="text-amber-700 font-bold">${totalDays}</span></p>
                        <p>المدخل: <span class="text-amber-700 font-bold">${dataEntryUser}</span></p>
                        <p>الحالة: <span class="text-amber-700 font-bold">${isApproved ? 'معتمد' : 'غير معتمد'}</span></p>
                    </div>

                    <div class="overflow-x-auto">
                    <table class="min-w-full border-collapse border border-gray-400 text-sm">
                        <thead class="bg-amber-300">
                            <tr>
                                <th class="border px-3 py-2 text-right w-1/4">البند الرئيسي</th>
                                <th class="border px-3 py-2 text-right w-1/3">البند الفرعي/مؤشر التقييم</th>
                                <th class="border px-3 py-2 w-1/4">مؤشرات الأداء للمقاول (%)</th>
                                <th class="border px-3 py-2 w-1/6">النسبة المئوية لجودة الأداء (%)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // تجميع المؤشرات وإظهارها بالتفصيل
            Object.keys(KPI_CATEGORIES).forEach(category => {
                const kpisInCategory = KPI_CATEGORIES[category];
                if (kpisInCategory.length === 0) return;

                // حساب مؤشر الأداء الشهري للقسم الرئيسي
                const categoryKPI = calculateCategoryKPI(filteredReports, kpisInCategory, siteStaff);
                totalOverallPercentage += parseFloat(categoryKPI);
                totalCategories++;

                kpisInCategory.forEach((kpi, index) => {
                    const kpiIndex = DATA.settings.kpis.findIndex(k => k.name === kpi.name);
                    const kpiWorkers = kpi.workers.filter(w => siteStaff.some(s => s.role === w));
                    
                    // حساب النسبة اليومية لهذا المؤشر
                    let kpiTotalScore = 0;
                    let kpiPossibleScore = 0;

                    filteredReports.forEach(report => {
                         kpiWorkers.forEach(requiredRole => {
                            siteStaff.forEach(staff => {
                                if (staff.role === requiredRole) {
                                    kpiPossibleScore++;
                                    const workerKey = staff.id;
                                    if (report.scores[kpiIndex] && report.scores[kpiIndex][workerKey]) {
                                        kpiTotalScore++;
                                    }
                                }
                            });
                        });
                    });

                    const kpiPercentage = kpiPossibleScore > 0 ? ((kpiTotalScore / kpiPossibleScore) * 100).toFixed(2) : '100.00';

                    tableHTML += `
                        <tr>
                            ${index === 0 ? `<td rowspan="${kpisInCategory.length}" class="border px-3 py-2 text-right font-bold bg-amber-100 align-top">${category}</td>` : ''}
                            <td class="border px-3 py-2 text-right">${kpi.name}</td>
                            <td class="border px-3 py-2 text-center text-blue-700">${kpiPercentage}%</td>
                            <td class="border px-3 py-2 text-center text-gray-500">-</td>
                        </tr>
                    `;
                });
                
                // إضافة صف المجموع الفرعي لكل فئة
                tableHTML += `
                    <tr class="font-bold bg-amber-200">
                        <td colspan="3" class="border px-3 py-2 text-left">مؤشر أداء ${category}</td>
                        <td class="border px-3 py-2 text-center text-lg ${categoryKPI >= 95 ? 'text-green-700' : 'text-red-700'}">${categoryKPI}%</td>
                    </tr>
                `;
            });

            const overallKPI = totalCategories > 0 ? (totalOverallPercentage / totalCategories).toFixed(2) : '0.00';

            // إضافة صف الإجمالي النهائي
            tableHTML += `
                    <tr class="font-extrabold bg-amber-400 text-lg">
                        <td colspan="3" class="border px-3 py-2 text-left">مؤشر الأداء الكلي الشهري</td>
                        <td class="border px-3 py-2 text-center ${overallKPI >= 95 ? 'text-green-800' : 'text-red-800'}">${overallKPI}%</td>
                    </tr>
                        </tbody>
                    </table>
                    </div>
                    
                    <div class="flex justify-between mt-8 text-center text-base">
                        <div class="flex flex-col">
                            <p class="font-semibold border-b border-gray-400 mb-2">المدخل (${dataEntryUser})</p>
                            ${dataEntryUserSignature ? 
                                `<div class="mt-2 p-2 border rounded-lg bg-white"><img src="${dataEntryUserSignature}" class="h-16 w-32 border border-gray-300 mx-auto" alt="توقيع المدخل"></div>` : 
                                `<div class="mt-2 p-2 border border-dashed rounded-lg bg-gray-100 text-sm text-gray-500">لا يوجد توقيع</div>`
                            }
                        </div>
                        <div class="flex flex-col">
                            <p class="font-semibold border-b border-gray-400 mb-2">اعتماد المسؤول</p>
                            ${APP_STATE.isApprover ? createSignatureArea(DATA.settings.users.find(u => u.role === 'approver'), 'kpi') : 
                                `<div class="mt-2 p-2 border rounded-lg bg-white">
                                    ${isApproved && approverSignature ? 
                                        `<img src="${approverSignature}" class="h-16 w-32 border border-gray-300 mx-auto" alt="التوقيع">` : 
                                        `<p class="text-sm text-gray-500">سيظهر التوقيع بعد الاعتماد</p>`
                                    }
                                </div>`
                            }
                            <p class="text-xs mt-1 text-gray-500">${isApproved ? 'تم الاعتماد' : 'مطلوب توقيع'}</p>
                        </div>
                    </div>
                </div>
            `;
            
            const content = document.getElementById('kpi-report-content');
            content.innerHTML = tableHTML;
        }
        
        function submitKPIReport() {
            const siteId = document.getElementById('site-select-kpi').value;
            const monthYear = document.getElementById('month-select-kpi').value;
            
            // إضافة إشعارات للمعتمدين
            const approverUsers = DATA.settings.users.filter(u => u.role === 'approver');
            
            approverUsers.forEach(user => {
                addNotification(user.id, `تم تقديم تقرير مؤشر الأداء الشهري لـ ${DATA.settings.sites.find(s => s.id === siteId).name} - ${monthYear} يحتاج إلى اعتماد`, 'kpi');
            });
            
            showSuccessToast('تم تقديم التقرير للاعتماد بنجاح');
        }
        
        function approveKPIReport() {
            const siteId = document.getElementById('site-select-kpi').value;
            const monthYear = document.getElementById('month-select-kpi').value;
            
            const approvalRecord = {
                id: crypto.randomUUID(),
                siteId: siteId,
                monthYear: monthYear,
                type: 'kpi',
                approvedBy: APP_STATE.loggedInUser.id,
                approvedAt: new Date().toISOString(),
                reportId: DATA.reports.find(r => r.siteId === siteId && r.date.startsWith(monthYear))?.id
            };
            
            DATA.approvedReports.push(approvalRecord);
            saveData();
            
            // إضافة إشعار للمستخدم المعني
            const site = DATA.settings.sites.find(s => s.id === siteId);
            const siteUsers = DATA.settings.users.filter(u => u.siteId === siteId || u.role === 'admin');
            
            siteUsers.forEach(user => {
                addNotification(user.id, `تم اعتماد تقرير مؤشر الأداء الشهري لـ ${site.name} - ${monthYear}`, 'kpi');
            });
            
            showSuccessToast('تم اعتماد تقرير مؤشر الأداء الشهري بنجاح.');
            navigate('monthlyKPI');
        }
        
        function exportKPIReportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            const element = document.getElementById('kpi-report-printable');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                width: element.scrollWidth,
                height: element.scrollHeight,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 280;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                // إضافة الصورة بحيث تملأ الصفحة
                doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                doc.save('تقرير_مؤشر_الأداء_الشهري.pdf');
            });
        }

        // === 10. شاشة التقرير الشهري ===

        function showMonthlyReport() {
            setupHeaderAndNav('التقرير الشهري');
            markNotificationsAsRead('monthly');

            const isCoordinator = APP_STATE.isCoordinator;
            const sitesToView = APP_STATE.isAdmin || isCoordinator ? DATA.settings.sites : [APP_STATE.currentSite];

            let contentHTML = `
                <div class="space-y-6">
                    <h2 class="text-3xl font-extrabold text-amber-900">التقرير الشهري</h2>
                    
                    <div class="flex flex-wrap items-center space-x-4 space-x-reverse gap-4 p-4 bg-amber-50 rounded-xl shadow-md">
                        ${(APP_STATE.isAdmin || isCoordinator) ? `
                            <label for="site-select-monthly" class="font-semibold text-amber-800">اختر المسلخ:</label>
                            <select id="site-select-monthly" class="p-2 border rounded-lg" onchange="renderMonthlyReport(this.value, document.getElementById('month-select-monthly').value)">
                                ${sitesToView.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                        ` : `<input type="hidden" id="site-select-monthly" value="${APP_STATE.currentSite.id}">`}

                        <label for="month-select-monthly" class="font-semibold text-amber-800">اختر الشهر:</label>
                        <input type="month" id="month-select-monthly" value="${new Date().toISOString().substring(0, 7)}" class="p-2 border rounded-lg" onchange="renderMonthlyReport(document.getElementById('site-select-monthly').value, this.value)">
                        <button onclick="exportMonthlyReportToPDF()" class="app-btn text-sm">تصدير التقرير (PDF)</button>
                        ${APP_STATE.isCoordinator ? `<button onclick="approveMonthlyReport()" class="app-btn bg-green-600 text-sm">اعتماد التقرير</button>` : ''}
                        ${!APP_STATE.isCoordinator ? `<button onclick="submitMonthlyReport()" class="app-btn bg-blue-600 text-sm">تقديم للاعتماد</button>` : ''}
                    </div>

                    <div id="monthly-report-content" class="bg-white p-6 rounded-xl shadow-2xl overflow-x-auto">
                        <!-- محتوى التقرير يظهر هنا -->
                    </div>
                </div>
            `;
            mainContent.innerHTML = contentHTML;

            const initialSiteId = sitesToView[0].id;
            renderMonthlyReport(initialSiteId, document.getElementById('month-select-monthly').value);
        }

        function renderMonthlyReport(siteId, monthYear) {
            const site = DATA.settings.sites.find(s => s.id === siteId);
            const operatorName = site.operator;
            const contractNumber = site.contract;
            
            // الحصول على اسم المستخدم المدخل للبيانات في آخر يوم من الشهر
            const filteredReports = DATA.reports.filter(r => r.siteId === siteId && r.date.startsWith(monthYear));
            const lastDayOfMonth = new Date(new Date(monthYear).getFullYear(), new Date(monthYear).getMonth() + 1, 0).getDate();
            const lastDayReport = filteredReports
                .filter(r => r.date === `${monthYear}-${lastDayOfMonth.toString().padStart(2, '0')}`)
                .pop();
            const dataEntryUser = lastDayReport ? lastDayReport.userName : 'غير معروف';
            
            // الحصول على توقيع المدخل
            const dataEntryUserObj = DATA.settings.users.find(u => u.name === dataEntryUser);
            const dataEntryUserSignature = dataEntryUserObj ? dataEntryUserObj.signature : null;
            
            // التحقق مما إذا كان التقرير معتمداً
            const existingMonthlyReport = DATA.monthlyReports.find(r => 
                r.siteId === siteId && 
                r.monthYear === monthYear
            );
            const isApproved = existingMonthlyReport ? existingMonthlyReport.isApproved : false;
            
            // الحصول على توقيع المنسق
            const coordinatorUser = DATA.settings.users.find(u => u.role === 'coordinator');
            const coordinatorSignature = isApproved ? coordinatorUser.signature : null;
            
            // حساب المخالفات لهذا الشهر
            const monthlyViolations = DATA.reports.flatMap(r => r.violations)
                .filter(v => v.siteId === siteId && v.reportDate.startsWith(monthYear) && v.isClosed);
            
            // تجميع المخالفات حسب النوع
            const violationCounts = {};
            DATA.settings.violations.forEach(v => {
                violationCounts[v.id] = {
                    name: v.name,
                    unit: v.unit,
                    count: 0,
                    notes: ''
                };
            });
            
            monthlyViolations.forEach(v => {
                if (violationCounts[v.violationId]) {
                    violationCounts[v.violationId].count++;
                    if (v.notes) {
                        violationCounts[v.violationId].notes += (violationCounts[v.violationId].notes ? '، ' : '') + v.notes;
                    }
                }
            });
            
            // بناء جدول المخالفات
            const violationRows = Object.values(violationCounts).map(v => `
                <tr>
                    <td class="border px-4 py-2 text-right">${v.name}</td>
                    <td class="border px-4 py-2 text-center">${v.unit}</td>
                    <td class="border px-4 py-2 text-center">${v.count}</td>
                    <td class="border px-4 py-2 text-right">${v.notes || ''}</td>
                </tr>
            `).join('');
            
            // تصميم التقرير الشهري المبسط
            const monthlyReportHTML = `
                <div id="monthly-report-printable" class="p-8 border-4 border-amber-800 rounded-2xl shadow-2xl bg-white relative" style="min-width: 1200px;">
                    <div class="text-center mb-6">
                        <h1 class="text-4xl font-extrabold text-amber-900 mb-2">التقرير الشهري</h1>
                        <div class="flex justify-between items-center text-lg">
                            <p>الشهر: <span class="font-bold">${getMonthName(monthYear)}</span></p>
                            <p>السنة: <span class="font-bold">${monthYear.split('-')[0]}</span></p>
                        </div>
                        <div class="text-lg mt-2">
                            <p>${site.name}</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <p class="text-xl font-bold">المتعهد: <span class="text-amber-800">${operatorName}</span></p>
                        <p class="text-lg">رقم العقد: <span class="font-bold">${contractNumber}</span></p>
                    </div>

                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-2">مخالفات العقد</h2>
                        <div class="overflow-x-auto">
                            <table class="monthly-report-table">
                                <thead>
                                    <tr>
                                        <th>نوع المخالفة</th>
                                        <th>الوحدة</th>
                                        <th>العدد</th>
                                        <th>ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${violationRows}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8 text-center text-base">
                        <div class="flex flex-col">
                            <p class="font-semibold border-b border-gray-400 mb-2">المدخل (${dataEntryUser})</p>
                            ${dataEntryUserSignature ? 
                                `<div class="mt-2 p-2 border rounded-lg bg-white"><img src="${dataEntryUserSignature}" class="h-16 w-32 border border-gray-300 mx-auto" alt="توقيع المدخل"></div>` : 
                                `<div class="mt-2 p-2 border border-dashed rounded-lg bg-gray-100 text-sm text-gray-500">لا يوجد توقيع</div>`
                            }
                        </div>
                        <div class="flex flex-col">
                            <p class="font-semibold border-b border-gray-400 mb-2">اعتماد رئيس الشعبة</p>
                            ${APP_STATE.isCoordinator ? createSignatureArea(DATA.settings.users.find(u => u.role === 'coordinator'), 'monthly') : 
                                `<div class="mt-2 p-2 border rounded-lg bg-white">
                                    ${isApproved && coordinatorSignature ? 
                                        `<img src="${coordinatorSignature}" class="h-16 w-32 border border-gray-300 mx-auto" alt="التوقيع">` : 
                                        `<p class="text-sm text-gray-500">سيظهر التوقيع بعد الاعتماد</p>`
                                    }
                                </div>`
                            }
                            <p class="text-xs mt-1 text-gray-500">${isApproved ? 'تم الاعتماد' : 'مطلوب توقيع'}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('monthly-report-content').innerHTML = monthlyReportHTML;
        }

        function getMonthName(monthYear) {
            const months = [
                'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
            ];
            const monthIndex = parseInt(monthYear.split('-')[1]) - 1;
            return months[monthIndex] || 'غير معروف';
        }

        function submitMonthlyReport() {
            const siteId = document.getElementById('site-select-monthly').value;
            const monthYear = document.getElementById('month-select-monthly').value;
            
            // إضافة إشعارات للمنسقين
            const coordinatorUsers = DATA.settings.users.filter(u => u.role === 'coordinator');
            
            coordinatorUsers.forEach(user => {
                addNotification(user.id, `تم تقديم التقرير الشهري لـ ${DATA.settings.sites.find(s => s.id === siteId).name} - ${monthYear} يحتاج إلى اعتماد`, 'monthly');
            });
            
            showSuccessToast('تم تقديم التقرير للاعتماد بنجاح');
        }

        function approveMonthlyReport() {
            const siteId = document.getElementById('site-select-monthly').value;
            const monthYear = document.getElementById('month-select-monthly').value;
            
            const existingReportIndex = DATA.monthlyReports.findIndex(r => 
                r.siteId === siteId && 
                r.monthYear === monthYear
            );
            
            if (existingReportIndex !== -1) {
                DATA.monthlyReports[existingReportIndex].isApproved = true;
                DATA.monthlyReports[existingReportIndex].approvedBy = APP_STATE.loggedInUser.id;
                DATA.monthlyReports[existingReportIndex].approvedAt = new Date().toISOString();
            } else {
                DATA.monthlyReports.push({
                    id: crypto.randomUUID(),
                    siteId: siteId,
                    monthYear: monthYear,
                    isApproved: true,
                    approvedBy: APP_STATE.loggedInUser.id,
                    approvedAt: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                });
            }
            
            saveData();
            
            // إضافة إشعار للمستخدم المعني
            const site = DATA.settings.sites.find(s => s.id === siteId);
            const siteUsers = DATA.settings.users.filter(u => u.siteId === siteId || u.role === 'admin');
            
            siteUsers.forEach(user => {
                addNotification(user.id, `تم اعتماد التقرير الشهري لـ ${site.name} - ${monthYear}`, 'monthly');
            });
            
            showSuccessToast('تم اعتماد التقرير الشهري بنجاح.');
            navigate('monthlyReport');
        }

        function exportMonthlyReportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            const element = document.getElementById('monthly-report-printable');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                width: element.scrollWidth,
                height: element.scrollHeight,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 280;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                doc.save('التقرير_الشهري.pdf');
            });
        }

        // === 11. شاشة الفاتورة الشهرية ===

        function showMonthlyInvoice() {
            setupHeaderAndNav('الفاتورة الشهرية');
            markNotificationsAsRead('invoice');

            const isApprover = APP_STATE.isApprover;
            // تم تعديل الصلاحية: المستخدم العادي يمكنه عرض الفاتورة لموقعه فقط
            const sitesToView = APP_STATE.isAdmin || isApprover || APP_STATE.isCoordinator ? DATA.settings.sites : [APP_STATE.currentSite];

            let contentHTML = `
                <div class="space-y-6">
                    <h2 class="text-3xl font-extrabold text-amber-900">مرجع الفاتورة الشهري</h2>
                    
                    <div class="flex flex-wrap items-center space-x-4 space-x-reverse">
                        ${(APP_STATE.isAdmin || isApprover || APP_STATE.isCoordinator) ? `
                            <label for="site-select-invoice" class="font-semibold text-amber-800">اختر المسلخ:</label>
                            <select id="site-select-invoice" class="p-2 border rounded-lg" onchange="renderInvoice(this.value, document.getElementById('month-select-invoice').value)">
                                ${sitesToView.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}
                            </select>
                        ` : `<input type="hidden" id="site-select-invoice" value="${APP_STATE.currentSite.id}">`}

                        <label for="month-select-invoice" class="font-semibold text-amber-800">اختر الشهر:</label>
                        <input type="month" id="month-select-invoice" value="${new Date().toISOString().substring(0, 7)}" class="p-2 border rounded-lg" onchange="renderInvoice(document.getElementById('site-select-invoice').value, this.value)">
                        <button onclick="exportInvoiceToPDF()" class="app-btn text-sm">تصدير الفاتورة (PDF)</button>
                        ${APP_STATE.isApprover ? `<button onclick="approveInvoice()" class="app-btn bg-green-600 text-sm">اعتماد الفاتورة</button>` : ''}
                        ${!APP_STATE.isApprover ? `<button onclick="submitInvoice()" class="app-btn bg-blue-600 text-sm">تقديم للاعتماد</button>` : ''}
                    </div>

                    <div id="invoice-content" class="bg-white p-6 rounded-xl shadow-2xl overflow-x-auto">
                        <!-- محتوى الفاتورة يظهر هنا -->
                    </div>
                </div>
            `;
            mainContent.innerHTML = contentHTML;

            const initialSiteId = sitesToView[0].id;
            renderInvoice(initialSiteId, document.getElementById('month-select-invoice').value);
        }

        // دالة محسنة لتحويل الأرقام إلى أحرف عربية (تتجاهل الأصفار على اليسار)
        function numberToArabicWords(number) {
            // تحويل الرقم إلى سلسلة وإزالة الأصفار غير المعنوية على اليسار
            const numStr = parseFloat(number).toString();
            
            // فصل الجزء الصحيح والجزء العشري
            const parts = numStr.split('.');
            const integerPart = parseInt(parts[0]);
            const decimalPart = parts.length > 1 ? parseInt(parts[1]) : 0;
            
            const units = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة'];
            const teens = ['عشرة', 'أحد عشر', 'اثنا عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
            const tens = ['', 'عشرة', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
            const hundreds = ['', 'مائة', 'مئتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
            
            if (integerPart === 0 && decimalPart === 0) return '';
            
            let result = '';
            
            // معالجة الآلاف
            if (integerPart >= 1000) {
                const thousands = Math.floor(integerPart / 1000);
                if (thousands === 1) {
                    result += 'ألف';
                } else if (thousands === 2) {
                    result += 'ألفان';
                } else if (thousands >= 3 && thousands <= 10) {
                    result += units[thousands] + ' آلاف';
                } else {
                    result += numberToArabicWords(thousands) + ' ألف';
                }
                const remainder = integerPart % 1000;
                if (remainder > 0) result += ' و ';
                number = remainder;
            } else {
                number = integerPart;
            }
            
            // معالجة المئات
            if (number >= 100) {
                const hundred = Math.floor(number / 100);
                result += hundreds[hundred];
                number %= 100;
                if (number > 0) result += ' و ';
            }
            
            // معالجة العشرات والآحاد
            if (number > 0) {
                if (number < 10) {
                    result += units[number];
                } else if (number < 20) {
                    result += teens[number - 10];
                } else {
                    const ten = Math.floor(number / 10);
                    const unit = number % 10;
                    if (unit === 0) {
                        result += tens[ten];
                    } else {
                        result += units[unit] + ' و ' + tens[ten];
                    }
                }
            }
            
            // إضافة الجزء العشري إذا كان موجوداً
            if (decimalPart > 0) {
                result += ' درهم و ';
                if (decimalPart < 10) {
                    result += units[decimalPart] + ' فلساً';
                } else if (decimalPart < 20) {
                    result += teens[decimalPart - 10] + ' فلساً';
                } else {
                    const ten = Math.floor(decimalPart / 10);
                    const unit = decimalPart % 10;
                    if (unit === 0) {
                        result += tens[ten] + ' فلساً';
                    } else {
                        result += units[unit] + ' و ' + tens[ten] + ' فلساً';
                    }
                }
            } else {
                result += ' درهم';
            }
            
            return result;
        }

        function renderInvoice(siteId, monthYear) {
            const site = DATA.settings.sites.find(s => s.id === siteId);
            const operatorName = site.operator;
            const contractNumber = site.contract;
            const invoiceNumber = `INV-${siteId}-${monthYear.replace('-', '')}`;
            const invoiceDate = new Date().toLocaleDateString('ar-EG');
            const invoiceCosts = DATA.settings.invoiceCosts;
            
            // تحديد المستخدم المعتمد
            const approverUser = DATA.settings.users.find(u => u.role === 'approver');
            
            // الحصول على اسم المستخدم المدخل للبيانات في آخر يوم من الشهر
            const filteredReports = DATA.reports.filter(r => r.siteId === siteId && r.date.startsWith(monthYear));
            const lastDayOfMonth = new Date(new Date(monthYear).getFullYear(), new Date(monthYear).getMonth() + 1, 0).getDate();
            const lastDayReport = filteredReports
                .filter(r => r.date === `${monthYear}-${lastDayOfMonth.toString().padStart(2, '0')}`)
                .pop();
            const dataEntryUser = lastDayReport ? lastDayReport.userName : 'غير معروف';
            
            // الحصول على توقيع المدخل
            const dataEntryUserObj = DATA.settings.users.find(u => u.name === dataEntryUser);
            const dataEntryUserSignature = dataEntryUserObj ? dataEntryUserObj.signature : null;
            
            // التحقق مما إذا كان التقرير معتمداً
            const isApproved = DATA.approvedReports.some(ar => 
                ar.siteId === siteId && 
                ar.monthYear === monthYear && 
                ar.type === 'invoice'
            );
            
            // الحصول على توقيع المعتمد
            const approverSignature = isApproved ? approverUser.signature : null;
            
            // 1. حساب الإجماليات
            let itemsTotal = 0;
            const invoiceItems = ['مشرف', 'محاسب', 'مراقب', 'قصاب', 'عامل نظافة', 'حمال', 'مواد التنظيف'];
            const itemDetails = invoiceItems.map((item, index) => {
                const count = item === 'مواد التنظيف' ? 1 : site.staff.filter(s => s.role === item).length;
                const cost = invoiceCosts[item] || 0;
                const total = count * cost;
                itemsTotal += total;
                return { index: index + 1, item, count, cost, total };
            });

            // 2. حساب الضرائب
            const taxRate = 0.05;
            const taxAmount = itemsTotal * taxRate;
            const totalBeforeAdjustments = itemsTotal + taxAmount;

            // 3. حساب الخصومات والتعديلات (مؤشر الأداء والمخالفات)
            
            // حساب مؤشر الأداء الكلي
            let totalOverallPercentage = 0;
            let totalCategories = 0;
            Object.keys(KPI_CATEGORIES).forEach(category => {
                const kpisInCategory = KPI_CATEGORIES[category];
                if (kpisInCategory.length === 0) return;
                const categoryKPI = calculateCategoryKPI(filteredReports, kpisInCategory, site.staff);
                totalOverallPercentage += parseFloat(categoryKPI);
                totalCategories++;
            });
            const averageKPI = totalCategories > 0 ? (totalOverallPercentage / totalCategories).toFixed(2) : '0.00';
            
            // خصم مؤشر الأداء: إذا كان الأداء أقل من 95%، يتم خصم 1% من الإجمالي قبل الضريبة لكل نقطة تحت الـ 90
            let kpiAdjustment = 0;
            if (parseFloat(averageKPI) < 90 && filteredReports.length > 0) {
                const deductionRate = (90 - parseFloat(averageKPI)) / 100;
                kpiAdjustment = -(itemsTotal * deductionRate);
            }
            // تقريب التعديل لأقرب عدد صحيح
            kpiAdjustment = Math.round(kpiAdjustment);

            // حساب قيمة المخالفات المغلقة
            const closedViolationsValue = DATA.reports.flatMap(r => r.violations)
                .filter(v => v.siteId === siteId && v.reportDate.startsWith(monthYear) && v.isClosed)
                .reduce((sum, v) => sum + v.value, 0);

            // 4. القيمة النهائية
            const finalValue = totalBeforeAdjustments + kpiAdjustment - closedViolationsValue;
            
            // تحويل المبلغ إلى أحرف باستخدام الدالة المحسنة
            const amountInWords = numberToArabicWords(finalValue);
            
            // بناء جدول الفاتورة الموسع
            const invoiceTableRows = itemDetails.map(d => `
                <tr>
                    <td class="border px-4 py-2">${d.index}</td>
                    <td class="border px-4 py-2 text-right">${d.item}</td>
                    <td class="border px-4 py-2 text-center">${d.count}</td>
                    <td class="border px-4 py-2 text-center">${d.cost.toLocaleString('ar-EG')}</td>
                    <td class="border px-4 py-2 text-center">${d.total.toLocaleString('ar-EG')}</td>
                </tr>
            `).join('');

            const dataEntrySignatureHtml = dataEntryUserSignature ? 
                `<div class="mt-2 p-2 border rounded-lg bg-white"><img src="${dataEntryUserSignature}" class="h-16 w-32 border border-gray-300 mx-auto" alt="توقيع المدخل"></div>` : 
                `<div class="mt-2 p-2 border border-dashed rounded-lg bg-gray-100 text-sm text-gray-500">لا يوجد توقيع</div>`;

            // تصميم الفاتورة الموسعة بنسق Landscape
            const invoiceHTML = `
                <div id="invoice-printable" class="p-8 border-4 border-amber-800 rounded-2xl shadow-2xl bg-white relative" style="min-width: 1200px;">
                    <div class="flex justify-between items-center mb-6 border-b-2 border-amber-500 pb-4">
                        <h1 class="text-4xl font-extrabold text-amber-900">مرجع الفاتورة الشهري</h1>
                        <div class="text-sm text-right">
                            <p class="font-semibold">رقم الفاتورة: <span class="text-amber-700">${invoiceNumber}</span></p>
                            <p>تاريخ الفاتورة: <span class="text-amber-700">${invoiceDate}</span></p>
                            <p>الحالة: <span class="text-amber-700">${isApproved ? 'معتمدة' : 'غير معتمدة'}</span></p>
                        </div>
                    </div>

                    <div class="bg-amber-50 p-4 rounded-lg mb-6 text-lg font-medium grid grid-cols-1 md:grid-cols-2 gap-2">
                        <p>اسم المشغل: <span class="font-bold text-amber-800">${operatorName}</span></p>
                        <p>الموقع: <span class="font-bold text-amber-800">${site.name}</span></p>
                        <p>رقم العقد: <span class="font-bold text-amber-800">${contractNumber}</span></p>
                        <p>الشهر: <span class="font-bold text-amber-800">${monthYear}</span></p>
                        <p>المدخل: <span class="font-bold text-amber-800">${dataEntryUser}</span></p>
                        <p>مؤشر الأداء: <span class="font-bold text-amber-800">${averageKPI}%</span></p>
                    </div>
                    
                    <div class="overflow-x-auto">
                    <table class="min-w-max border-collapse border border-gray-400 mb-6 text-sm">
                        <thead class="bg-amber-200">
                            <tr>
                                <th class="border px-4 py-2 w-16">الرقم</th>
                                <th class="border px-4 py-2 text-right">البند</th>
                                <th class="border px-4 py-2 w-20">العدد</th>
                                <th class="border px-4 py-2 w-32">المبلغ الشهري</th>
                                <th class="border px-4 py-2 w-40">الإجمالي الكلي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceTableRows}
                            <tr class="font-bold bg-amber-50">
                                <td colspan="4" class="border px-4 py-2 text-left">المبلغ الكلي قبل الضريبة</td>
                                <td class="border px-4 py-2 text-center">${itemsTotal.toLocaleString('ar-EG')}</td>
                            </tr>
                            <tr class="bg-gray-100">
                                <td colspan="4" class="border px-4 py-2 text-left">الضريبة (5%)</td>
                                <td class="border px-4 py-2 text-center">${taxAmount.toLocaleString('ar-EG')}</td>
                            </tr>
                            <tr class="font-extrabold bg-green-100">
                                <td colspan="4" class="border px-4 py-2 text-left">المبلغ الكلي مع الضريبة</td>
                                <td class="border px-4 py-2 text-center">${totalBeforeAdjustments.toLocaleString('ar-EG')}</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="border px-4 py-2 text-left text-red-700">مخالفات على المشغل (المخالفات المغلقة)</td>
                                <td class="border px-4 py-2 text-center text-red-700">(${closedViolationsValue.toLocaleString('ar-EG')})</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="border px-4 py-2 text-left ${kpiAdjustment > 0 ? 'text-green-700' : 'text-red-700'}">تعديل مؤشر الأداء الشهري (متوسط ${averageKPI}%)</td>
                                <td class="border px-4 py-2 text-center ${kpiAdjustment >= 0 ? 'text-green-700' : 'text-red-700'}">${kpiAdjustment.toLocaleString('ar-EG', { signDisplay: 'exceptZero' })}</td>
                            </tr>
                            <tr class="font-extrabold bg-amber-300 text-2xl">
                                <td colspan="4" class="border px-4 py-2 text-left">القيمة الكلية النهائية</td>
                                <td class="border px-4 py-2 text-center">${finalValue.toLocaleString('ar-EG')}</td>
                            </tr>
                        </tbody>
                    </table>
                    </div>

                    <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-lg font-bold text-blue-800 text-center">${amountInWords} فقط لا غير</p>
                    </div>

                    <div class="flex justify-between mt-8 text-center text-base">
                        <div class="flex flex-col">
                            <p class="font-semibold border-b border-gray-400 mb-2">المدخل (${dataEntryUser})</p>
                            ${dataEntrySignatureHtml}
                        </div>
                        <div class="flex flex-col">
                            <p class="font-semibold border-b border-gray-400 mb-2">اعتماد المسؤول (${approverUser.name})</p>
                            ${APP_STATE.isApprover ? createSignatureArea(approverUser, 'invoice') : 
                                `<div class="mt-2 p-2 border rounded-lg bg-white">
                                    ${isApproved && approverSignature ? 
                                        `<img src="${approverSignature}" class="h-16 w-32 border border-gray-300 mx-auto" alt="التوقيع">` : 
                                        `<p class="text-sm text-gray-500">سيظهر التوقيع بعد الاعتماد</p>`
                                    }
                                </div>`
                            }
                            <p class="text-xs mt-1 text-gray-500">${isApproved ? 'تم الاعتماد' : 'مطلوب توقيع'}</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('invoice-content').innerHTML = invoiceHTML;
            document.getElementById('invoice-print-view').innerHTML = invoiceHTML; 
        }

        function submitInvoice() {
            const siteId = document.getElementById('site-select-invoice').value;
            const monthYear = document.getElementById('month-select-invoice').value;
            
            // إضافة إشعارات للمعتمدين
            const approverUsers = DATA.settings.users.filter(u => u.role === 'approver');
            
            approverUsers.forEach(user => {
                addNotification(user.id, `تم تقديم الفاتورة الشهرية لـ ${DATA.settings.sites.find(s => s.id === siteId).name} - ${monthYear} يحتاج إلى اعتماد`, 'invoice');
            });
            
            showSuccessToast('تم تقديم الفاتورة للاعتماد بنجاح');
        }

        function approveInvoice() {
            const siteId = document.getElementById('site-select-invoice').value;
            const monthYear = document.getElementById('month-select-invoice').value;
            
            const approvalRecord = {
                id: crypto.randomUUID(),
                siteId: siteId,
                monthYear: monthYear,
                type: 'invoice',
                approvedBy: APP_STATE.loggedInUser.id,
                approvedAt: new Date().toISOString(),
                reportId: DATA.reports.find(r => r.siteId === siteId && r.date.startsWith(monthYear))?.id
            };
            
            DATA.approvedReports.push(approvalRecord);
            saveData();
            
            // إضافة إشعار للمستخدم المعني
            const site = DATA.settings.sites.find(s => s.id === siteId);
            const siteUsers = DATA.settings.users.filter(u => u.siteId === siteId || u.role === 'admin');
            
            siteUsers.forEach(user => {
                addNotification(user.id, `تم اعتماد الفاتورة الشهرية لـ ${site.name} - ${monthYear}`, 'invoice');
            });
            
            showSuccessToast('تم اعتماد الفاتورة الشهرية بنجاح.');
            navigate('monthlyInvoice');
        }

        function exportInvoiceToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            const element = document.getElementById('invoice-printable');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                logging: false,
                width: element.scrollWidth,
                height: element.scrollHeight,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 280;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                // إضافة الصورة بحيث تملأ الصفحة
                doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                doc.save('فاتورة_خدمات_المقاول.pdf');
            });
        }

        // === 12. شاشة توقيع المستخدم ===

        function showUserSignature() {
            setupHeaderAndNav('توقيعي الشخصي');
            
            const user = APP_STATE.loggedInUser;
            const signature = user.signature;
            
            mainContent.innerHTML = `
                <div class="space-y-6">
                    <h2 class="text-3xl font-extrabold text-amber-900">إدارة توقيعي الشخصي</h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-2xl">
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-amber-800 mb-3">التوقيع الحالي</h3>
                            ${signature ? 
                                `<div class="signature-container">
                                    <img src="${signature}" class="signature-preview mx-auto" alt="توقيعي">
                                    <div class="text-center mt-2">
                                        <button onclick="removeMySignature()" class="app-btn bg-red-500 hover:bg-red-600 text-sm">حذف التوقيع</button>
                                    </div>
                                </div>` : 
                                `<div class="signature-container text-center text-gray-500">
                                    <p>لا يوجد توقيع مرفق حالياً</p>
                                </div>`
                            }
                        </div>
                        
                        <div class="mb-6">
                            <h3 class="text-xl font-semibold text-amber-800 mb-3">إضافة توقيع جديد</h3>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold mb-2">التوقيع باستخدام اللوحة</h4>
                                    <div class="border border-dashed border-gray-300 rounded-lg p-4 bg-gray-50">
                                        <canvas id="signaturePad" width="400" height="150" class="border border-gray-300 rounded-md bg-white touch-none mx-auto block" style="cursor: crosshair;"></canvas>
                                        <div class="text-center mt-2">
                                            <button onclick="clearSignaturePad()" class="app-btn bg-gray-500 hover:bg-gray-600 text-sm mr-2">مسح اللوحة</button>
                                            <button onclick="saveMySignature()" class="app-btn bg-green-500 hover:bg-green-600 text-sm">حفظ التوقيع</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h4 class="font-semibold mb-2">رفع صورة التوقيع</h4>
                                    <div class="border border-dashed border-gray-300 rounded-lg p-4 bg-gray-50 text-center">
                                        <input type="file" id="uploadSignatureFile" accept="image/*" class="hidden" onchange="uploadMySignature()">
                                        <button onclick="document.getElementById('uploadSignatureFile').click()" class="app-btn bg-blue-500 hover:bg-blue-600 text-sm">اختر صورة التوقيع</button>
                                        <p class="text-sm text-gray-500 mt-2">يمكنك رفع صورة لتوقيعك الشخصي</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-amber-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-amber-800 mb-2">ملاحظات:</h4>
                            <ul class="list-disc list-inside text-sm text-amber-700 space-y-1">
                                <li>سيظهر توقيعك في التقارير والفاتورة التي تدخلها</li>
                                <li>يمكنك استخدام اللوحة للرسم مباشرة أو رفع صورة للتوقيع</li>
                                <li>التوقيع ضروري لاعتماد التقارير والفاتورة</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            // تهيئة لوحة التوقيع
            initSignaturePad();
        }

        function saveMySignature() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;

            const context = canvas.getContext('2d');
            const data = context.getImageData(0, 0, canvas.width, canvas.height).data;
            let isEmpty = true;
            for (let i = 0; i < data.length; i++) {
                if (data[i] !== 0) {
                    isEmpty = false;
                    break;
                }
            }

            if (isEmpty) {
                showModal('تنبيه', 'الرجاء التوقيع على اللوحة أولاً.', 'userSignature');
                return;
            }

            const dataURL = canvas.toDataURL('image/png');
            updateMySignature(dataURL);
        }

        function uploadMySignature() {
            const fileInput = document.getElementById('uploadSignatureFile');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateMySignature(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        function updateMySignature(signatureDataUrl) {
            const user = DATA.settings.users.find(u => u.id === APP_STATE.loggedInUser.id);
            if (user) {
                user.signature = signatureDataUrl;
                saveData();
                showSuccessToast('تم حفظ التوقيع بنجاح');
                showUserSignature();
            }
        }

        function removeMySignature() {
            const user = DATA.settings.users.find(u => u.id === APP_STATE.loggedInUser.id);
            if (user) {
                user.signature = null;
                saveData();
                showSuccessToast('تم حذف التوقيع بنجاح');
                showUserSignature();
            }
        }

        function clearSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function createSignatureArea(user, type) {
            const signature = user.signature;
            if (signature) {
                return `
                    <div class="mt-2 p-2 border rounded-lg bg-white">
                        <img src="${signature}" class="h-16 w-32 border border-gray-300 mx-auto" alt="التوقيع">
                    </div>
                `;
            } else {
                return `
                    <div class="mt-2 p-2 border border-dashed rounded-lg bg-gray-100">
                        <p class="text-xs text-gray-500 mb-1">لا يوجد توقيع</p>
                    </div>
                `;
            }
        }

        // ربط التوقيع بالماوس واللمس
        function initSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let drawing = false;

            // إعدادات القلم
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            function startPosition(e) {
                drawing = true;
                draw(e);
            }

            function endPosition() {
                drawing = false;
                ctx.beginPath();
            }

            function draw(e) {
                if (!drawing) return;
                
                // تحديد إحداثيات الماوس أو اللمس بالنسبة للـ canvas
                const clientRect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - clientRect.left;
                const y = (e.clientY || e.touches[0].clientY) - clientRect.top;

                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
                e.preventDefault();
            }

            // Mouse events
            canvas.addEventListener('mousedown', startPosition);
            canvas.addEventListener('mouseup', endPosition);
            canvas.addEventListener('mousemove', draw);

            // Touch events
            canvas.addEventListener('touchstart', startPosition);
            canvas.addEventListener('touchend', endPosition);
            canvas.addEventListener('touchmove', draw);
        }

        // === 13. شاشة الإعدادات (Admin Only) ===

        function showSettings() {
            if (!APP_STATE.isAdmin) {
                showModal('خطأ', 'ليس لديك صلاحية الوصول لهذه الشاشة.', 'dashboard');
                return;
            }
            setupHeaderAndNav('الإعدادات');

            mainContent.innerHTML = `
                <div class="space-y-8">
                    <h2 class="text-3xl font-extrabold text-amber-900 border-b pb-2">إعدادات النظام (الأدمن)</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${createSettingsCard('إدارة المستخدمين والصلاحيات', 'users', 'bg-blue-100', showUserManagement)}
                        ${createSettingsCard('إدارة المواقع والمشغلين', 'sites', 'bg-green-100', showSiteManagement)}
                        ${createSettingsCard('إدارة العاملين', 'staff', 'bg-purple-100', showStaffManagement)}
                        ${createSettingsCard('تعديل مؤشرات التقييم', 'kpis', 'bg-purple-100', showKpiManagement)}
                        ${createSettingsCard('إعدادات الفواتير والمخالفات', 'invoicing', 'bg-red-100', showInvoiceManagement)}
                        ${createSettingsCard('تغيير صورة الترحيب', 'splash', 'bg-yellow-100', showSplashManagement)}
                        ${createSettingsCard('تغيير صورة المؤشر', 'kpiImage', 'bg-indigo-100', showKpiImageManagement)}
                    </div>

                    <div id="settings-detail-view" class="mt-8 bg-white p-6 rounded-xl shadow-2xl border border-gray-200">
                        <p class="text-lg text-gray-500">اختر أحد أقسام الإدارة من الأعلى للبدء.</p>
                    </div>
                </div>
            `;
        }

        function createSettingsCard(title, id, bgColor, action) {
            return `
                <div onclick="${action.name}()" class="p-6 ${bgColor} rounded-xl shadow-lg cursor-pointer hover:shadow-xl transition duration-300">
                    <h3 class="text-xl font-semibold text-gray-800">${title}</h3>
                </div>
            `;
        }
        
        // إدارة صورة المؤشر
        function showKpiImageManagement() {
            const detailView = document.getElementById('settings-detail-view');
            detailView.innerHTML = `
                <h3 class="text-2xl font-semibold text-indigo-700 mb-4">تغيير صورة مؤشر الأداء</h3>
                <img src="${DATA.settings.kpiImageUrl}" class="w-32 h-32 rounded-lg shadow-md mb-4" alt="صورة المؤشر الحالية">
                <input type="file" id="newKpiImage" accept="image/*" class="mb-4 p-2 border rounded-lg">
                <button onclick="updateKpiImage()" class="app-btn bg-indigo-600 hover:bg-indigo-700">تحديث الصورة</button>
                <p class="mt-4 text-sm text-gray-500">ملاحظة: حجم الصورة المفضل هو 250x250 بكسل.</p>
            `;
        }

        function updateKpiImage() {
            const fileInput = document.getElementById('newKpiImage');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    DATA.settings.kpiImageUrl = e.target.result;
                    saveData();
                    showSuccessToast('تم تحديث صورة المؤشر بنجاح');
                };
                reader.readAsDataURL(file);
            } else {
                showModal('خطأ', 'الرجاء اختيار صورة أولاً.', 'settings');
            }
        }
        
        // إدارة العاملين الجديدة
        function showStaffManagement() {
            const detailView = document.getElementById('settings-detail-view');
            
            const staffTables = DATA.settings.sites.map(site => `
                <div class="mb-8">
                    <h4 class="text-xl font-semibold text-purple-700 mb-4">${site.name}</h4>
                    <div class="overflow-x-auto">
                        <table class="staff-table min-w-full bg-white border border-gray-300 rounded-lg overflow-hidden shadow-md">
                            <thead class="bg-purple-100">
                                <tr>
                                    <th class="py-2 px-3 border text-right">الاسم</th>
                                    <th class="py-2 px-3 border text-right">الوظيفة</th>
                                    <th class="py-2 px-3 border text-center">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="staff-list-${site.id}">
                                ${site.staff.map(staff => `
                                    <tr>
                                        <td class="border py-2 px-3">
                                            <input type="text" value="${staff.name}" class="w-full p-1 border rounded staff-name" data-site="${site.id}" data-id="${staff.id}">
                                        </td>
                                        <td class="border py-2 px-3">
                                            <select class="w-full p-1 border rounded staff-role" data-site="${site.id}" data-id="${staff.id}">
                                                <option value="مشرف" ${staff.role === 'مشرف' ? 'selected' : ''}>مشرف</option>
                                                <option value="محاسب" ${staff.role === 'محاسب' ? 'selected' : ''}>محاسب</option>
                                                <option value="مراقب" ${staff.role === 'مراقب' ? 'selected' : ''}>مراقب</option>
                                                <option value="قصاب" ${staff.role === 'قصاب' ? 'selected' : ''}>قصاب</option>
                                                <option value="عامل نظافة" ${staff.role === 'عامل نظافة' ? 'selected' : ''}>عامل نظافة</option>
                                                <option value="حمال" ${staff.role === 'حمال' ? 'selected' : ''}>حمال</option>
                                            </select>
                                        </td>
                                        <td class="border py-2 px-3 text-center">
                                            <button onclick="updateStaff('${site.id}', '${staff.id}')" class="app-btn bg-green-500 hover:bg-green-600 p-1 text-xs">تحديث</button>
                                            <button onclick="deleteStaff('${site.id}', '${staff.id}')" class="app-btn bg-red-500 hover:bg-red-600 p-1 text-xs mr-2">حذف</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 bg-purple-50 p-4 rounded-lg">
                        <h5 class="font-semibold mb-2">إضافة عامل جديد لـ ${site.name}</h5>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <input type="text" id="new-staff-name-${site.id}" placeholder="اسم العامل" class="p-2 border rounded-lg">
                            <select id="new-staff-role-${site.id}" class="p-2 border rounded-lg">
                                <option value="مشرف">مشرف</option>
                                <option value="محاسب">محاسب</option>
                                <option value="مراقب">مراقب</option>
                                <option value="قصاب">قصاب</option>
                                <option value="عامل نظافة">عامل نظافة</option>
                                <option value="حمال">حمال</option>
                            </select>
                            <button onclick="addStaff('${site.id}')" class="app-btn bg-purple-500 hover:bg-purple-600 text-sm">إضافة العامل</button>
                        </div>
                    </div>
                </div>
            `).join('');

            detailView.innerHTML = `
                <h3 class="text-2xl font-semibold text-purple-700 mb-4">إدارة العاملين</h3>
                <div class="bg-purple-50 p-4 rounded-lg mb-6 shadow-md">
                    <p class="text-purple-700">هنا يمكنك إدارة العاملين في كل موقع. سيتم تحديث التغييرات مباشرة في التقييم اليومي.</p>
                </div>
                ${staffTables}
            `;
        }

        function addStaff(siteId) {
            const nameInput = document.getElementById(`new-staff-name-${siteId}`);
            const roleSelect = document.getElementById(`new-staff-role-${siteId}`);
            
            const name = nameInput.value.trim();
            const role = roleSelect.value;
            
            if (!name) {
                showModal('خطأ', 'يرجى إدخال اسم العامل.', 'settings');
                return;
            }
            
            const site = DATA.settings.sites.find(s => s.id === siteId);
            if (site) {
                const newStaff = {
                    id: `STAFF_${Date.now()}`,
                    name: name,
                    role: role
                };
                
                site.staff.push(newStaff);
                saveData();
                
                showStaffManagement();
            }
        }

        function updateStaff(siteId, staffId) {
            const nameInput = document.querySelector(`.staff-name[data-site="${siteId}"][data-id="${staffId}"]`);
            const roleSelect = document.querySelector(`.staff-role[data-site="${siteId}"][data-id="${staffId}"]`);
            
            const name = nameInput.value.trim();
            const role = roleSelect.value;
            
            if (!name) {
                showModal('خطأ', 'يرجى إدخال اسم العامل.', 'settings');
                return;
            }
            
            const site = DATA.settings.sites.find(s => s.id === siteId);
            if (site) {
                const staff = site.staff.find(s => s.id === staffId);
                if (staff) {
                    staff.name = name;
                    staff.role = role;
                    saveData();
                   
                }
            }
        }

        function deleteStaff(siteId, staffId) {
            if (confirm('هل أنت متأكد من حذف هذا العامل؟')) {
                const site = DATA.settings.sites.find(s => s.id === siteId);
                if (site) {
                    site.staff = site.staff.filter(s => s.id !== staffId);
                    saveData();
                    showSuccessToast('تم حذف العامل بنجاح');
                    showStaffManagement();
                }
            }
        }
        
        function showUserManagement() {
             const detailView = document.getElementById('settings-detail-view');
             const siteOptions = DATA.settings.sites.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

             detailView.innerHTML = `
                <h3 class="text-2xl font-semibold text-blue-700 mb-4">إدارة المستخدمين</h3>
                <div class="bg-blue-50 p-4 rounded-lg mb-6 shadow-md">
                    <h4 class="font-bold mb-2">إضافة مستخدم جديد</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="newUserName" placeholder="الاسم" class="p-2 border rounded-lg">
                        <input type="number" id="newUserCode" placeholder="الرقم الوظيفي" class="p-2 border rounded-lg">
                        <select id="newUserRole" class="p-2 border rounded-lg">
                            <option value="user">مستخدم عادي</option>
                            <option value="admin">مدير (أدمن)</option>
                            <option value="approver">معتمد تقارير فقط</option>
                            <option value="coordinator">منسق (رئيس الشعبة)</option>
                        </select>
                        <select id="newUserSite" class="p-2 border rounded-lg">
                            <option value="">اختر الموقع (للمستخدم العادي)</option>
                            ${siteOptions}
                        </select>
                    </div>
                    <button onclick="addUser()" class="app-btn bg-blue-500 hover:bg-blue-600 text-sm mt-3 w-full">إضافة</button>
                </div>

                <h4 class="font-bold text-lg mb-2">قائمة المستخدمين الحاليين</h4>
                <div id="user-list" class="space-y-3">
                    ${DATA.settings.users.map(u => `
                        <div class="p-3 border rounded-lg flex justify-between items-center bg-white shadow-sm">
                            <span class="text-sm">${u.name} (<b class="text-amber-700">${u.id}</b>) - الصلاحية: <b class="text-blue-600">${u.role}</b> - الموقع: ${DATA.settings.sites.find(s => s.id === u.siteId)?.name || 'الكل'}</span>
                            <button onclick="deleteUser('${u.id}')" class="text-red-500 hover:text-red-700 p-1 text-xs">حذف</button>
                        </div>
                    `).join('')}
                </div>
             `;
        }

        function addUser() {
            const name = document.getElementById('newUserName').value.trim();
            const id = document.getElementById('newUserCode').value.trim();
            const role = document.getElementById('newUserRole').value;
            const siteId = document.getElementById('newUserSite').value;

            if (!name || !id || !role) {
                showModal('خطأ', 'يرجى ملء جميع الحقول المطلوبة.', 'settings');
                return;
            }

            if (DATA.settings.users.find(u => u.id === id)) {
                showModal('خطأ', 'الرقم الوظيفي موجود مسبقاً.', 'settings');
                return;
            }

            DATA.settings.users.push({ id, name, role, siteId: role === 'user' ? siteId : 'All', signature: null });
            saveData();
            
            showUserManagement();
        }

        function deleteUser(id) {
            if (id === '70062') {
                 showModal('خطأ', 'لا يمكن حذف المستخدم الأدمن الرئيسي.', 'settings');
                return;
            }
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                DATA.settings.users = DATA.settings.users.filter(u => u.id !== id);
                saveData();
                showUserManagement();
               
            }
        }

        function showSiteManagement() {
            const detailView = document.getElementById('settings-detail-view');
            detailView.innerHTML = `
                <h3 class="text-2xl font-semibold text-green-700 mb-4">إدارة المواقع والمشغلين</h3>
                
                <div class="bg-green-50 p-4 rounded-lg mb-6 shadow-md">
                    <h4 class="font-bold mb-2">إضافة موقع جديد</h4>
                    <input type="text" id="newSiteName" placeholder="اسم الموقع (مثل مسلخ غياثي)" class="w-full p-2 border rounded-lg mb-2">
                    <input type="text" id="newOperator" placeholder="اسم المشغل (مثل شركة الجزيرة الخضراء)" class="w-full p-2 border rounded-lg mb-2">
                    <input type="text" id="newContract" placeholder="رقم العقد (مثل DRM-0024/2)" class="w-full p-2 border rounded-lg mb-2">
                    <button onclick="addSite()" class="app-btn bg-green-500 hover:bg-green-600 text-sm w-full">إضافة الموقع</button>
                </div>

                <h4 class="font-bold text-lg mb-2">قائمة المواقع الحالية</h4>
                <div id="site-list" class="space-y-3">
                    ${DATA.settings.sites.map(s => `
                        <div class="p-3 border rounded-lg bg-white shadow-sm flex justify-between items-center">
                            <div>
                                <p class="font-bold text-sm">${s.name} (<span class="text-gray-500">${s.id}</span>)</p>
                                <p class="text-xs">المشغل: ${s.operator} | العقد: ${s.contract}</p>
                            </div>
                            <button onclick="deleteSite('${s.id}')" class="text-red-500 hover:text-red-700 p-1 text-xs">حذف</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function addSite() {
            const name = document.getElementById('newSiteName').value.trim();
            const operator = document.getElementById('newOperator').value.trim();
            const contract = document.getElementById('newContract').value.trim();
            const id = name.replace(/\s/g, '').substring(0, 5) + Math.floor(Math.random() * 100);

            if (!name || !operator || !contract) {
                showModal('خطأ', 'يرجى ملء جميع حقول الموقع.', 'settings');
                return;
            }

            // إنشاء قائمة عمال افتراضية للموقع الجديد
            const defaultStaff = [
                { role: 'مشرف', name: 'مشرف جديد', id: 'M_NEW' },
                { role: 'محاسب', name: 'محاسب جديد', id: 'A_NEW' },
                { role: 'مراقب', name: 'مراقب جديد', id: 'S_NEW' },
                { role: 'قصاب', name: 'قصاب جديد 1', id: 'B_NEW1' },
                { role: 'قصاب', name: 'قصاب جديد 2', id: 'B_NEW2' },
                { role: 'قصاب', name: 'قصاب جديد 3', id: 'B_NEW3' },
                { role: 'قصاب', name: 'قصاب جديد 4', id: 'B_NEW4' },
                { role: 'عامل نظافة', name: 'عامل نظافة جديد 1', id: 'C_NEW1' },
                { role: 'عامل نظافة', name: 'عامل نظافة جديد 2', id: 'C_NEW2' },
                { role: 'حمال', name: 'حمال جديد', id: 'L_NEW' }
            ];

            DATA.settings.sites.push({ id, name, operator, contract, staff: defaultStaff });
            saveData();
           
            showSiteManagement();
        }

        function deleteSite(id) {
             if (confirm('هل أنت متأكد من حذف هذا الموقع؟ سيؤدي هذا إلى حذف جميع التقارير المرتبطة به.')) {
                DATA.settings.sites = DATA.settings.sites.filter(s => s.id !== id);
                DATA.reports = DATA.reports.filter(r => r.siteId !== id);
                DATA.settings.users.forEach(u => { if(u.siteId === id) u.siteId = DATA.settings.sites[0]?.id || ''; });
                saveData();
                showSiteManagement();
                
            }
        }

        function showKpiManagement() {
            const detailView = document.getElementById('settings-detail-view');
            const kpiListHTML = DATA.settings.kpis.map((k, index) => {
                const workers = k.workers.join(', ');
                return `
                    <div class="p-3 border rounded-lg bg-white shadow-sm flex flex-col space-y-2">
                        <div class="flex justify-between items-start">
                            <input type="text" value="${k.name}" class="p-1 border rounded-md flex-grow" onchange="updateKpiName(${index}, this.value)">
                            <button onclick="deleteKpi(${index})" class="text-red-500 hover:text-red-700 p-1 text-xs ml-2 flex-shrink-0">حذف</button>
                        </div>
                        <div class="flex justify-between text-xs text-gray-600">
                             <input type="text" value="${k.category}" class="p-1 border rounded-md w-1/3" onchange="updateKpiCategory(${index}, this.value)" title="فئة المؤشر">
                             <span class="w-2/3 text-right">المعنيون: ${workers}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            const categoryOptions = Object.keys(KPI_CATEGORIES).map(c => `<option value="${c}">${c}</option>`).join('');

            detailView.innerHTML = `
                <h3 class="text-2xl font-semibold text-purple-700 mb-4">تعديل مؤشرات التقييم</h3>
                
                <div class="bg-purple-50 p-4 rounded-lg mb-6 shadow-md">
                    <h4 class="font-bold mb-2">إضافة مؤشر جديد</h4>
                    <input type="text" id="newKpiName" placeholder="اسم مؤشر التقييم" class="w-full p-2 border rounded-lg mb-2">
                    <select id="newKpiCategory" class="w-full p-2 border rounded-lg mb-2">
                        ${categoryOptions}
                        <option value="جديدة">فئة جديدة...</option>
                    </select>
                    <div class="space-x-2 space-x-reverse flex flex-wrap mb-2">
                        ${['مشرف', 'محاسب', 'مراقب', 'قصاب', 'عامل نظافة', 'حمال'].map(staff => `
                            <label class="text-sm">
                                <input type="checkbox" data-staff="${staff}" class="form-checkbox text-purple-600 rounded"> ${staff}
                            </label>
                        `).join('')}
                    </div>
                    <button onclick="addKpi()" class="app-btn bg-purple-500 hover:bg-purple-600 text-sm w-full">إضافة المؤشر</button>
                </div>

                <h4 class="font-bold text-lg mb-2">قائمة مؤشرات التقييم الحالية</h4>
                <div id="kpi-list" class="space-y-3">
                    ${kpiListHTML}
                </div>
            `;
        }

        function addKpi() {
            const name = document.getElementById('newKpiName').value.trim();
            const category = document.getElementById('newKpiCategory').value;
            const workers = Array.from(document.querySelectorAll('#settings-detail-view input[type="checkbox"]:checked')).map(cb => cb.dataset.staff);

            if (!name || !category) { showModal('خطأ', 'الرجاء إدخال اسم المؤشر والفئة.', 'settings'); return; }

            const newCategory = category === 'جديدة' ? prompt('أدخل اسم الفئة الجديدة:') : category;
            if (!newCategory) return;
            
            DATA.settings.kpis.push({ name, category: newCategory, workers });
            if (!KPI_CATEGORIES[newCategory]) KPI_CATEGORIES[newCategory] = [];
            KPI_CATEGORIES[newCategory].push({ name, category: newCategory, workers });
            
            saveData();
            
            showKpiManagement();
        }

        function updateKpiName(index, newName) {
            const oldKpi = DATA.settings.kpis[index];
            if (oldKpi) {
                oldKpi.name = newName;
                const categoryArray = KPI_CATEGORIES[oldKpi.category];
                if (categoryArray) {
                    const kpiToUpdate = categoryArray.find(k => k === oldKpi);
                    if (kpiToUpdate) kpiToUpdate.name = newName;
                }
                saveData();
            }
        }
        
        function updateKpiCategory(index, newCategory) {
            const oldKpi = DATA.settings.kpis[index];
            if (oldKpi && oldKpi.category !== newCategory) {
                const oldCategoryArray = KPI_CATEGORIES[oldKpi.category];
                if (oldCategoryArray) {
                    KPI_CATEGORIES[oldKpi.category] = oldCategoryArray.filter(k => k !== oldKpi);
                }
                
                if (!KPI_CATEGORIES[newCategory]) KPI_CATEGORIES[newCategory] = [];
                KPI_CATEGORIES[newCategory].push(oldKpi);
                
                oldKpi.category = newCategory;
                
                saveData();
                showKpiManagement();
            }
        }

        function deleteKpi(index) {
            if (confirm('هل أنت متأكد من حذف هذا المؤشر؟')) {
                const deletedKpi = DATA.settings.kpis.splice(index, 1)[0];
                
                const categoryArray = KPI_CATEGORIES[deletedKpi.category];
                if (categoryArray) {
                    KPI_CATEGORIES[deletedKpi.category] = categoryArray.filter(k => k !== deletedKpi);
                }
                
                saveData();
                showKpiManagement();
            }
        }

        function showInvoiceManagement() {
            const detailView = document.getElementById('settings-detail-view');
            detailView.innerHTML = `
                <h3 class="text-2xl font-semibold text-red-700 mb-4">إعدادات الفواتير والمخالفات</h3>
                
                <h4 class="text-xl font-semibold mt-4 text-amber-800">1. تكاليف البنود الشهرية</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-2 bg-amber-50 p-4 rounded-lg">
                    ${Object.entries(DATA.settings.invoiceCosts).map(([item, cost]) => `
                        <div class="p-2 border rounded-lg bg-white shadow-sm">
                            <label class="block text-sm font-medium">${item}</label>
                            <input type="number" value="${cost}" class="w-full p-1 border rounded-md text-sm mt-1" onchange="updateInvoiceCost('${item}', this.value)" title="المبلغ الشهري">
                        </div>
                    `).join('')}
                </div>

                <h4 class="text-xl font-semibold mt-6 text-red-800">2. قواعد المخالفات وقيم الخصم</h4>
                <div class="space-y-3 mt-2 bg-red-50 p-4 rounded-lg">
                    ${DATA.settings.violations.map(v => `
                        <div class="p-3 border rounded-lg bg-white shadow-sm flex justify-between items-center">
                            <input type="text" value="${v.name}" class="p-1 border rounded-md flex-grow" onchange="updateViolationName(${v.id}, this.value)">
                            <input type="number" value="${v.value}" class="p-1 border rounded-md w-24 text-center ml-2" onchange="updateViolationValue(${v.id}, this.value)">
                            <button onclick="deleteViolationSettings(${v.id})" class="text-red-500 hover:text-red-700 p-1 text-xs flex-shrink-0">حذف</button>
                        </div>
                    `).join('')}
                    <button onclick="addViolationSettings()" class="app-btn bg-red-500 hover:bg-red-600 p-2 text-sm mt-3 w-full">إضافة مخالفة جديدة</button>
                </div>
            `;
        }

        function updateInvoiceCost(item, cost) {
            DATA.settings.invoiceCosts[item] = parseInt(cost) || 0;
            saveData();
        }

        function updateViolationName(id, name) {
            const v = DATA.settings.violations.find(x => x.id === id);
            if (v) v.name = name; saveData();
        }
        function updateViolationValue(id, value) {
            const v = DATA.settings.violations.find(x => x.id === id);
            if (v) v.value = parseInt(value) || 0; saveData();
        }
        function deleteViolationSettings(id) {
            if (confirm('هل أنت متأكد من حذف هذه المخالفة من الإعدادات؟ لن يتم حذفها من التقارير القديمة.')) {
                DATA.settings.violations = DATA.settings.violations.filter(v => v.id !== id);
                saveData();
                showInvoiceManagement();
            }
        }
        function addViolationSettings() {
            const newId = (DATA.settings.violations.length > 0 ? Math.max(...DATA.settings.violations.map(v => v.id)) : 0) + 1;
            DATA.settings.violations.push({ 
                id: newId, 
                name: 'مخالفة جديدة', 
                value: 100,
                category: 'الإدارة',
                description: 'مخالفة جديدة'
            });
            saveData();
            showInvoiceManagement();
        }

        function showSplashManagement() {
            const detailView = document.getElementById('settings-detail-view');
            detailView.innerHTML = `
                <h3 class="text-2xl font-semibold text-yellow-700 mb-4">تغيير صورة شاشة الترحيب</h3>
                <img src="${DATA.settings.splashImageUrl}" class="w-32 h-32 rounded-lg shadow-md mb-4" alt="صورة الترحيب الحالية">
                <input type="file" id="newSplashImage" accept="image/*" class="mb-4 p-2 border rounded-lg">
                <button onclick="updateSplashImage()" class="app-btn bg-yellow-600 hover:bg-yellow-700">تحديث الصورة</button>
                <p class="mt-4 text-sm text-gray-500">ملاحظة: حجم الصورة المفضل هو 250x250 بكسل.</p>
            `;
        }

        function updateSplashImage() {
            const fileInput = document.getElementById('newSplashImage');
            const file = fileInput.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    DATA.settings.splashImageUrl = e.target.result;
                    saveData();
                    showSuccessToast('تم تحديث صورة الترحيب بنجاح');
                };
                reader.readAsDataURL(file);
            } else {
                showModal('خطأ', 'الرجاء اختيار صورة أولاً.', 'settings');
            }
        }

        // === 14. وظيفة الرسائل المخصصة (بديل لـ alert) ===

        function showModal(title, message, navigateToScreen = 'dashboard', params = {}) {
            const modalHTML = `
                <div id="modalOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                        <h3 class="text-2xl font-bold mb-4 text-amber-800">${title}</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button onclick="closeModal('${navigateToScreen}', ${JSON.stringify(params)})" class="app-btn">إغلاق</button>
                    </div>
                </div>
            `;
            appModalContainer.innerHTML = modalHTML;
            appModalContainer.classList.remove('hidden');
        }

        function closeModal(navigateToScreen, params) {
            document.getElementById('modalOverlay')?.remove();
            appModalContainer.classList.add('hidden');
            if (APP_STATE.isAuthReady) {
                navigate(navigateToScreen, params);
            }
        }

        // === 15. تشغيل التطبيق ===

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            if (!loadCurrentState()) {
                showSplashScreen();
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            const observer = new MutationObserver((mutationsList, observer) => {
                for(const mutation of mutationsList) {
                    if (mutation.type === 'childList' && document.getElementById('signaturePad')) {
                        initSignaturePad();
                        observer.disconnect(); 
                    }
                }
            });

            observer.observe(mainContent, { childList: true, subtree: true });
        });
    </script>
</body>

</html>
